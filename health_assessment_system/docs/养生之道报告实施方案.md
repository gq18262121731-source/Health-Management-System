# 养生之道·智能健康报告 实施方案

## 一、方案概述

本方案为现有健康评估系统添加"养生之道·智能健康报告"功能，生成符合您模板要求的标准化健康报告。

## 二、新增文件清单

| 文件路径 | 功能说明 |
|---------|---------|
| `modules/health_report_models.py` | 报告数据模型定义 |
| `modules/indicator_evaluator.py` | 指标评估器（状态判断） |
| `modules/yangsheng_report_generator.py` | 报告生成器（核心） |
| `config/indicator_reference.json` | 指标参考范围配置 |
| `examples/yangsheng_report_demo.py` | 完整演示脚本 |

## 三、核心数据结构

### 3.1 老人基本信息 (`ElderBasicInfo`)

```python
@dataclass
class ElderBasicInfo:
    elder_id: str           # 老人ID
    elder_name: str         # 姓名
    elder_gender: str       # 性别（男/女）
    elder_age: int          # 年龄
    elder_phone: str        # 联系电话
    elder_address: str      # 居住地区
    elder_chronic_tags: List[str]  # 既往记录标签
```

### 3.2 生命体征 (`VitalSigns`)

```python
@dataclass
class VitalSigns:
    spo2: VitalSignIndicator           # 血氧
    heart_rate: VitalSignIndicator     # 心率
    systolic_bp: VitalSignIndicator    # 收缩压
    diastolic_bp: VitalSignIndicator   # 舒张压
    pulse_rate: VitalSignIndicator     # 脉率
    body_temperature: VitalSignIndicator  # 体温
```

### 3.3 代谢指标 (`MetabolicIndicators`)

```python
@dataclass
class MetabolicIndicators:
    blood_sugar: VitalSignIndicator    # 血糖
    uric_acid: VitalSignIndicator      # 血尿酸
    weight: VitalSignIndicator         # 体重
    bmi: VitalSignIndicator            # BMI
```

### 3.4 完整报告数据 (`HealthReportData`)

包含以下六个部分：
1. **基本信息** - `elder_info`
2. **关键指标一览** - `vital_signs` + `metabolic_indicators`
3. **近期变化趋势** - `trend_analysis`
4. **系统特征识别小结** - `feature_recognition`
5. **历史对比与个体基线** - `baseline_comparison`
6. **报告说明** - `disclaimer`

## 四、模板变量对照表

您模板中的变量与系统数据的对应关系：

| 模板变量 | 数据来源 | 说明 |
|---------|---------|------|
| `{{elder_name}}` | `elder_info.elder_name` | 老人姓名 |
| `{{elder_age}}` | `elder_info.elder_age` | 年龄 |
| `{{elder_gender}}` | `elder_info.elder_gender` | 性别 |
| `{{elder_phone}}` | `elder_info.elder_phone` | 电话 |
| `{{elder_address}}` | `elder_info.elder_address` | 地址 |
| `{{elder_chronic_tags}}` | `elder_info.get_chronic_tags_text()` | 既往标签 |
| `{{report_date}}` | `report_date` | 报告日期 |
| `{{spo2}}` | `vital_signs.spo2.value` | 血氧值 |
| `{{spo2_status_text}}` | `vital_signs.spo2.status_text` | 血氧状态描述 |
| `{{heart_rate}}` | `vital_signs.heart_rate.value` | 心率值 |
| `{{systolic_bp}}` | `vital_signs.systolic_bp.value` | 收缩压值 |
| `{{diastolic_bp}}` | `vital_signs.diastolic_bp.value` | 舒张压值 |
| `{{blood_sugar}}` | `metabolic_indicators.blood_sugar.value` | 血糖值 |
| `{{uric_acid}}` | `metabolic_indicators.uric_acid.value` | 血尿酸值 |
| `{{weight_kg}}` | `metabolic_indicators.weight.value` | 体重 |
| `{{bmi}}` | `metabolic_indicators.bmi.value` | BMI |
| `{{trend_window_start}}` | `trend_analysis.trend_window_start` | 趋势开始日期 |
| `{{trend_window_end}}` | `trend_analysis.trend_window_end` | 趋势结束日期 |
| `{{valid_check_count}}` | `trend_analysis.valid_check_count` | 有效检测次数 |
| `{{bp_trend_stat_text}}` | `trend_analysis.bp_trend.stat_text` | 血压统计文本 |
| `{{bp_trend_desc}}` | `trend_analysis.bp_trend.trend_desc` | 血压趋势描述 |
| `{{feature_overview_text}}` | `feature_recognition.feature_overview_text` | 特征概览 |
| `{{combined_feature_text}}` | `feature_recognition.combined_feature_text` | 组合特征 |
| `{{system_focus_points}}` | `feature_recognition.system_focus_points` | 关注点列表 |
| `{{personal_baseline_desc}}` | `baseline_comparison.personal_baseline_desc` | 基线描述 |
| `{{bp_vs_baseline_text}}` | `baseline_comparison.bp_vs_baseline_text` | 血压对比 |
| `{{sugar_vs_baseline_text}}` | `baseline_comparison.sugar_vs_baseline_text` | 血糖对比 |

## 五、使用方法

### 5.1 基本使用

```python
from modules import (
    ElderBasicInfo,
    YangShengReportGenerator
)

# 1. 创建老人信息
elder_info = ElderBasicInfo(
    elder_id="E001",
    elder_name="张三",
    elder_gender="男",
    elder_age=72,
    elder_phone="13800138000",
    elder_address="北京市朝阳区",
    elder_chronic_tags=["高血压", "血糖偏高倾向"]
)

# 2. 准备当前测量数据
current_measurements = {
    'spo2': 97,
    'heart_rate': 78,
    'systolic_bp': 145,
    'diastolic_bp': 88,
    'pulse_rate': 76,
    'body_temperature': 36.5,
    'blood_sugar': 6.8,
    'uric_acid': 380,
    'weight': 68,
    'height': 170
}

# 3. 准备历史数据（可选）
historical_data = {
    'check_count': 15,
    'systolic_bp_history': [138, 142, 145, ...],
    'blood_sugar_history': [6.2, 6.5, 6.8, ...]
}

# 4. 准备基线数据（可选）
baseline_data = {
    'baseline_days': 90,
    'systolic_bp': {'mean': 138, 'p25': 132, 'p75': 145},
    'blood_sugar': {'mean': 6.3, 'p25': 5.9, 'p75': 6.8}
}

# 5. 生成报告
generator = YangShengReportGenerator()
report = generator.generate_report(
    elder_info=elder_info,
    current_measurements=current_measurements,
    historical_data=historical_data,
    baseline_data=baseline_data
)

# 6. 输出报告
text_report = generator.render_text_report(report)
html_report = generator.render_html_report(report)
json_report = generator.render_json_report(report)
```

### 5.2 获取模板变量

```python
# 获取所有模板变量（用于自定义模板渲染）
template_vars = report.to_template_vars()

# 示例输出
print(template_vars['elder_name'])  # 张三
print(template_vars['systolic_bp'])  # 145
print(template_vars['systolic_bp_status_text'])  # 略高于系统参考上限
```

## 六、指标状态判断逻辑

### 6.1 状态枚举

```python
class IndicatorStatus(Enum):
    NORMAL = "normal"           # 正常范围内
    SLIGHTLY_HIGH = "slightly_high"  # 略高
    SLIGHTLY_LOW = "slightly_low"    # 略低
    HIGH = "high"               # 偏高
    LOW = "low"                 # 偏低
    CRITICAL_HIGH = "critical_high"  # 严重偏高
    CRITICAL_LOW = "critical_low"    # 严重偏低
    NO_DATA = "no_data"         # 暂无数据
```

### 6.2 状态描述文本示例

| 状态 | 描述文本 |
|-----|---------|
| NORMAL | 位于系统设定参考范围内 |
| SLIGHTLY_HIGH | 略高于系统参考上限（参考范围：90 - 140 mmHg） |
| HIGH | 高于系统参考范围（参考范围：90 - 140 mmHg） |
| CRITICAL_HIGH | 明显高于系统参考上限（参考范围：90 - 140 mmHg） |

### 6.3 参考范围配置

参考范围定义在 `config/indicator_reference.json`，可根据需要调整：

```json
{
  "systolic_bp": {
    "name": "收缩压",
    "unit": "mmHg",
    "normal_low": 90,
    "normal_high": 140,
    "warning_high": 160,
    "critical_high": 180
  }
}
```

## 七、与现有系统集成

### 7.1 从现有评估结果生成报告

```python
from core import HealthAssessmentEngine
from modules import YangShengReportGenerator, ElderBasicInfo

# 运行现有评估
engine = HealthAssessmentEngine()
assessment_result = engine.run_scheduled_assessment(user_id="USER001")

# 转换为养生之道报告
elder_info = ElderBasicInfo(
    elder_id="USER001",
    elder_name="张三",
    # ... 从用户档案获取
)

# 从评估结果提取测量数据
current_measurements = {
    'systolic_bp': assessment_result.disease_results.get('hypertension', {}).get('sbp_mean'),
    # ... 其他指标
}

# 生成报告
generator = YangShengReportGenerator()
report = generator.generate_report(elder_info, current_measurements)
```

## 八、输出格式

系统支持三种输出格式：

1. **文本格式** - `render_text_report()` - 适合终端显示、打印
2. **HTML格式** - `render_html_report()` - 适合网页展示、邮件发送
3. **JSON格式** - `render_json_report()` - 适合API接口、前端渲染

## 九、扩展建议

### 9.1 添加新指标

1. 在 `health_report_models.py` 中添加指标字段
2. 在 `indicator_evaluator.py` 中添加参考范围
3. 在 `yangsheng_report_generator.py` 中添加处理逻辑

### 9.2 自定义报告模板

使用 `to_template_vars()` 方法获取所有变量，然后用任意模板引擎（如Jinja2）渲染：

```python
from jinja2 import Template

template = Template(open('my_template.html').read())
html = template.render(**report.to_template_vars())
```

### 9.3 PDF导出

可集成 `weasyprint` 或 `pdfkit` 将HTML转换为PDF：

```python
import pdfkit
html = generator.render_html_report(report)
pdfkit.from_string(html, 'report.pdf')
```

## 十、文件结构

```
health_assessment_system/
├── modules/
│   ├── health_report_models.py      # 数据模型 ✨新增
│   ├── indicator_evaluator.py       # 指标评估器 ✨新增
│   ├── yangsheng_report_generator.py # 报告生成器 ✨新增
│   └── __init__.py                  # 已更新导出
├── config/
│   └── indicator_reference.json     # 参考范围配置 ✨新增
├── examples/
│   └── yangsheng_report_demo.py     # 演示脚本 ✨新增
└── docs/
    └── 养生之道报告实施方案.md       # 本文档 ✨新增
```

## 十一、运行演示

```bash
cd health_assessment_system
python examples/yangsheng_report_demo.py
```

演示将生成：
- 控制台文本报告
- `examples/yangsheng_report_demo.html` - HTML报告
- `examples/yangsheng_report_demo.json` - JSON数据
