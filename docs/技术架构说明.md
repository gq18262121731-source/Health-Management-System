# 智能诊断系统 - 技术架构说明

## 项目概述

面向老年人的智能健康诊断系统，集成数据采集、AI诊断、语音交互三大核心能力。

---

# 一、数据处理技术

## 1.1 技术栈

| 技术 | 用途 | 说明 |
|------|------|------|
| Python | 后端语言 | 数据处理、API服务 |
| Flask | Web框架 | RESTful API |
| Pandas/NumPy | 数据处理 | 统计计算、数据清洗 |
| SQLite/MySQL | 数据存储 | 健康数据持久化 |

## 1.2 解决的问题

### 问题1：健康数据异常值干扰分析
**解决方案：多策略异常值检测**

```
┌─────────────────────────────────────────────────────┐
│                异常值检测流程                        │
├─────────────────────────────────────────────────────┤
│  原始数据                                           │
│     ↓                                               │
│  ① IQR 四分位距法 (统计异常)                        │
│     Q1 - 1.5×IQR < 正常值 < Q3 + 1.5×IQR           │
│     ↓                                               │
│  ② Z-Score 标准分法 (离群检测)                      │
│     |Z| > 3 判定为异常                              │
│     ↓                                               │
│  ③ 业务规则校验 (医学常识)                          │
│     血压: 70-200 mmHg                               │
│     心率: 35-200 bpm                                │
│     血糖: 2.0-30.0 mmol/L                           │
│     ↓                                               │
│  清洁数据 + 数据质量报告                            │
└─────────────────────────────────────────────────────┘
```

**核心代码位置：** `core/data_pipeline.py` → `DataCleaner` 类

---

### 问题2：多源数据格式不统一
**解决方案：统一数据采集层**

```python
# 支持的数据源
class DataSource(Enum):
    SENSOR = "sensor"      # 传感器自动采集
    MANUAL = "manual"      # 手动输入
    API = "api"            # 外部API
    BATCH = "batch"        # 批量导入

# 统一数据格式
@dataclass
class RawDataRecord:
    record_id: str
    user_id: str
    data_type: str         # blood_pressure, glucose, heart_rate...
    values: Dict[str, Any] # 统一字段结构
    timestamp: datetime
    source: DataSource
```

---

### 问题3：健康趋势难以量化
**解决方案：特征工程提取**

| 特征类型 | 计算方法 | 意义 |
|----------|----------|------|
| 均值 | mean() | 整体水平 |
| 标准差 | std() | 波动程度 |
| 变异系数 | std/mean | 稳定性 |
| 趋势斜率 | 线性回归 | 上升/下降趋势 |
| 达标率 | 正常值占比 | 控制效果 |
| 最大波动 | max - min | 极端情况 |

**核心代码位置：** `modules/data_preparation.py` → `FeatureEngineer` 类

---

# 二、AI智能体技术

## 2.1 技术栈

| 技术 | 用途 | 说明 |
|------|------|------|
| 讯飞星火 v3.5 | 大语言模型 | AI对话核心 |
| WebSocket | 实时通信 | 流式响应 |
| 多智能体架构 | 任务分发 | 专业化处理 |

## 2.2 解决的问题

### 问题1：通用LLM缺乏健康领域专业性
**解决方案：上下文注入（Context Injection）**

```
┌─────────────────────────────────────────────────────┐
│              上下文注入机制                          │
├─────────────────────────────────────────────────────┤
│                                                     │
│  用户提问: "我血压高怎么办？"                        │
│                   ↓                                  │
│  ┌─────────────────────────────────────────────┐    │
│  │         动态构建系统提示词                    │    │
│  │                                             │    │
│  │  [角色定义]                                  │    │
│  │  你是专业的老年健康顾问...                    │    │
│  │                                             │    │
│  │  [用户健康档案] ← 从数据库实时获取           │    │
│  │  - 姓名: 张奶奶, 72岁                        │    │
│  │  - 基础病: 高血压                            │    │
│  │  - 用药: 硝苯地平缓释片                      │    │
│  │                                             │    │
│  │  [实时健康数据] ← 今日最新数据               │    │
│  │  - 血压: 145/92 mmHg (偏高)                  │    │
│  │  - 心率: 78 bpm (正常)                       │    │
│  │  - 睡眠: 5.5小时 (不足)                      │    │
│  │                                             │    │
│  │  [健康评估] ← AI自动分析结果                 │    │
│  │  - 血压控制: 中等风险                        │    │
│  │  - 建议: 注意监测，避免情绪激动              │    │
│  └─────────────────────────────────────────────┘    │
│                   ↓                                  │
│  讯飞星火 LLM 生成个性化回复                        │
│                   ↓                                  │
│  "张奶奶，您今天的血压145/92确实偏高了，            │
│   比您平时的基线高了10mmHg左右..."                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**核心代码位置：** `src/services/sparkApi.ts` → `buildSystemPrompt()` 函数

---

### 问题2：单一AI无法覆盖所有场景
**解决方案：多智能体协作系统**

```
┌─────────────────────────────────────────────────────┐
│               多智能体架构                           │
├─────────────────────────────────────────────────────┤
│                                                     │
│                 用户输入                             │
│                    ↓                                │
│            ┌──────────────┐                         │
│            │ 协调器       │  ← 意图识别 + 路由分发   │
│            │ Coordinator  │                         │
│            └──────┬───────┘                         │
│       ┌──────┬───┴───┬──────┐                       │
│       ↓      ↓       ↓      ↓                       │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐       │
│  │慢病专家│ │情感关怀│ │健康管家│ │生活教练│       │
│  │        │ │        │ │        │ │        │       │
│  │血压血糖│ │心理疏导│ │用药提醒│ │运动饮食│       │
│  │糖尿病  │ │情绪识别│ │预约体检│ │睡眠改善│       │
│  └────────┘ └────────┘ └────────┘ └────────┘       │
│                                                     │
└─────────────────────────────────────────────────────┘

意图路由规则：
- "血压高/血糖高/糖尿病" → 慢病专家
- "心情不好/焦虑/孤独"   → 情感关怀
- "吃药/体检/预约"       → 健康管家
- "运动/饮食/睡眠"       → 生活教练
```

**核心代码位置：** `agents/multi_agent_system.py`

---

### 问题3：AI响应延迟影响体验
**解决方案：WebSocket 流式响应**

```
传统HTTP请求:
  用户提问 ─────────[等待3-5秒]─────────→ 完整回复

WebSocket流式:
  用户提问 → 您 → 好 → ， → 张 → 奶 → 奶 → ... → [完成]
            ↑    ↑    ↑
          即时显示每个token，体验更流畅
```

**核心代码位置：** `src/services/sparkApi.ts` → `sendToSpark()` 函数

---

# 三、语音交互技术

## 3.1 技术栈

| 技术 | 用途 | 说明 |
|------|------|------|
| SenseVoice | 语音识别(ASR) | 阿里开源，中文效果好 |
| Edge-TTS | 语音合成(TTS) | 微软免费TTS，多种音色 |
| FunASR | ASR框架 | SenseVoice运行环境 |

## 3.2 解决的问题

### 问题1：老年人打字困难
**解决方案：语音输入**

```
┌─────────────────────────────────────────────────────┐
│               语音识别流程 (ASR)                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  麦克风录音                                         │
│      ↓                                              │
│  音频数据 (.wav)                                    │
│      ↓                                              │
│  ┌─────────────────────────────┐                    │
│  │      SenseVoice 模型        │                    │
│  │  - 支持中文普通话/方言      │                    │
│  │  - 自动语言检测             │                    │
│  │  - 噪声鲁棒性强             │                    │
│  └─────────────────────────────┘                    │
│      ↓                                              │
│  识别文本: "我今天血压有点高"                       │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 问题2：老年人阅读困难
**解决方案：语音播报**

```
┌─────────────────────────────────────────────────────┐
│               语音合成流程 (TTS)                     │
├─────────────────────────────────────────────────────┤
│                                                     │
│  AI回复文本                                         │
│      ↓                                              │
│  ┌─────────────────────────────┐                    │
│  │       Edge-TTS 服务         │                    │
│  │                             │                    │
│  │  可用语音:                   │                    │
│  │  - 晓伊 (温柔女声) ← 默认    │                    │
│  │  - 云希 (阳光男声)           │                    │
│  │  - 晓晓 (活泼女声)           │                    │
│  │                             │                    │
│  │  适老化配置:                 │                    │
│  │  - 语速: -15% (稍慢)         │                    │
│  │  - 音量: +10% (稍大)         │                    │
│  └─────────────────────────────┘                    │
│      ↓                                              │
│  音频文件 (.mp3)                                    │
│      ↓                                              │
│  前端播放                                           │
│                                                     │
└─────────────────────────────────────────────────────┘
```

---

### 问题3：语音交互不连贯
**解决方案：ASR + LLM + TTS 一体化流程**

```
┌─────────────────────────────────────────────────────┐
│               完整语音对话流程                       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ① 用户说话                                         │
│       ↓                                             │
│  ② SenseVoice 语音识别                              │
│       ↓ 文字                                        │
│  ③ 讯飞星火 AI 处理                                 │
│       ↓ AI回复文字                                  │
│  ④ Edge-TTS 语音合成                                │
│       ↓ 音频                                        │
│  ⑤ 播放给用户听                                     │
│       ↓                                             │
│  ⑥ 继续监听 (循环)                                  │
│                                                     │
│  API: POST /api/voice/chat                          │
│  一次请求完成全流程                                  │
│                                                     │
└─────────────────────────────────────────────────────┘
```

**核心代码位置：** `src/health_assessment_system/web_digital_human/voice_api.py`

---

# 四、技术总结

## 4.1 核心技术亮点

| 亮点 | 技术实现 | 解决的问题 |
|------|----------|------------|
| **上下文注入** | 动态构建System Prompt | 让通用LLM具备个性化健康诊断能力 |
| **多智能体** | 意图路由 + 专家分工 | 覆盖慢病、情感、生活等多场景 |
| **流式响应** | WebSocket | 消除AI响应等待感 |
| **多策略清洗** | IQR + Z-Score + 业务规则 | 保证健康数据分析准确性 |
| **语音闭环** | ASR + LLM + TTS | 实现全语音交互，适老化 |

## 4.2 技术栈全景

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (React + TypeScript)                │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐            │
│  │ 健康仪表盘│  │ AI对话  │  │ 语音交互 │  │ 数据可视化│            │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘            │
└─────────────────────────────────────────────────────────────────┘
                              ↕ API
┌─────────────────────────────────────────────────────────────────┐
│                        后端 (Python Flask)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ 数据处理层   │  │ AI服务层    │  │ 语音服务层   │              │
│  │             │  │             │  │             │              │
│  │ DataPipeline│  │ MultiAgent  │  │ SenseVoice  │              │
│  │ DataCleaner │  │ 讯飞星火    │  │ Edge-TTS    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────────┐
│                        数据层 (SQLite/MySQL)                    │
│  用户信息 │ 健康记录 │ 评估结果 │ 对话历史                        │
└─────────────────────────────────────────────────────────────────┘
```

## 4.3 第三方服务

| 服务 | 提供商 | 用途 | 费用 |
|------|--------|------|------|
| 讯飞星火 v3.5 | 科大讯飞 | AI对话 | 有免费额度 |
| Edge-TTS | 微软 | 语音合成 | 免费 |
| SenseVoice | 阿里(开源) | 语音识别 | 免费(本地部署) |
