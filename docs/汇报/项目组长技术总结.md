# 项目组长技术总结

> 养生之道智能健康管理系统 - 项目统筹、语音交互系统、LLM对话服务

---

## 一、负责模块概览

| 模块 | 技术栈 | 核心职责 |
|------|--------|----------|
| **项目统筹** | 系统架构设计 | 总体技术方案、模块划分、接口设计 |
| **语音交互系统** | FunASR + Edge-TTS | 语音识别(ASR) + 语音合成(TTS) |
| **LLM对话服务** | DeepSeek API | 大模型调用、Prompt工程、对话管理 |

---

## 二、技术架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        语音交互 + LLM对话架构                             │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│   │  用户语音    │ →  │   FunASR    │ →  │   文字处理   │                 │
│   │  (麦克风)    │    │ SenseVoice  │    │   意图分析   │                 │
│   └─────────────┘    └─────────────┘    └──────┬──────┘                 │
│                                                 │                        │
│                                                 ▼                        │
│                            ┌─────────────────────────────────┐          │
│                            │        DeepSeek LLM            │          │
│                            │  ┌─────────────────────────┐   │          │
│                            │  │  Prompt 工程             │   │          │
│                            │  │  · 系统角色设定          │   │          │
│                            │  │  · 健康知识上下文        │   │          │
│                            │  │  · 对话历史管理          │   │          │
│                            │  └─────────────────────────┘   │          │
│                            └───────────────┬─────────────────┘          │
│                                            │                            │
│                                            ▼                            │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                 │
│   │  语音播放    │ ←  │  Edge-TTS   │ ←  │   AI回复    │                 │
│   │  (扬声器)    │    │  语音合成    │    │   文本      │                 │
│   └─────────────┘    └─────────────┘    └─────────────┘                 │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心代码模块

### 3.1 代码文件清单

| 目录 | 文件 | 功能 | 代码行数 |
|------|------|------|----------|
| `backend/services/` | `voice_service.py` | 语音识别+合成服务 | 282 行 |
| `backend/services/` | `ai_service.py` | LLM对话服务 | ~400 行 |
| `backend/services/` | `spark_service.py` | 讯飞星火接口 | ~200 行 |
| `backend/routers/` | `ai_router.py` | AI对话API路由 | ~150 行 |
| `backend/routers/` | `voice_router.py` | 语音API路由 | ~100 行 |

**总代码量**：约 **1,200+ 行** Python 代码

---

## 四、语音交互系统 (ASR/TTS)

### 4.1 Edge-TTS 语音合成

**技术选型理由**：
- ✅ 微软Azure语音质量，免费使用
- ✅ 多种中文语音可选，支持情感表达
- ✅ 支持语速、音量调节（适老化）
- ✅ 异步流式生成，低延迟

**语音角色配置**：
| 语音ID | 名称 | 特点 | 适用场景 |
|--------|------|------|----------|
| xiaoxiao | 晓晓 | 温柔女声 | **默认推荐**，适老化 |
| yunxi | 云希 | 年轻男声 | 活力场景 |
| yunyang | 云扬 | 播音男声 | 正式通知 |

### 4.2 FunASR 语音识别

**技术选型理由**：
- ✅ 阿里达摩院开源，中文识别率高
- ✅ SenseVoice模型，支持情感识别
- ✅ 支持GPU加速，实时转写
- ✅ 支持VAD语音端点检测

---

## 五、🎯 核心代码展示（演讲用）

### 【演讲代码片段】语音服务核心实现

```python
"""语音服务 - ASR(语音识别) + TTS(语音合成)"""

class VoiceService:
    """语音服务类 - 支持语音识别和语音合成"""
    
    # Edge-TTS 中文语音列表（适老化选择）
    VOICES = {
        "xiaoxiao": "zh-CN-XiaoxiaoNeural",  # 女声，温柔（推荐）
        "yunxi": "zh-CN-YunxiNeural",        # 男声，年轻
        "yunyang": "zh-CN-YunyangNeural",    # 男声，新闻播报
    }
    
    def __init__(self):
        self.default_voice = "xiaoxiao"  # 默认使用温柔女声，适合老年人
        self.asr_model = None
        self._init_asr()
    
    def _init_asr(self):
        """初始化 ASR 模型 (SenseVoice)"""
        from funasr import AutoModel
        self.asr_model = AutoModel(
            model="iic/SenseVoiceSmall",    # 阿里达摩院语音识别模型
            vad_model="fsmn-vad",           # 语音端点检测
            vad_kwargs={"max_single_segment_time": 30000},
            trust_remote_code=True,
            device="cuda:0"                 # GPU加速
        )
    
    async def text_to_speech(
        self,
        text: str,
        voice: str = "xiaoxiao",
        rate: str = "+0%",      # 正常语速
        volume: str = "+10%"    # 音量稍大（适老化）
    ) -> Tuple[str, str]:
        """
        文本转语音 (TTS) - 使用Edge-TTS
        
        技术亮点：
        1. 异步生成，不阻塞主线程
        2. 支持语速/音量调节，适老化设计
        3. 自动生成唯一音频文件ID
        """
        voice_name = self.VOICES.get(voice, self.VOICES["xiaoxiao"])
        audio_id = str(uuid.uuid4())
        audio_path = f"./audio_cache/{audio_id}.mp3"
        
        # 使用 Edge-TTS 生成语音
        communicate = edge_tts.Communicate(
            text=text,
            voice=voice_name,
            rate=rate,
            volume=volume
        )
        await communicate.save(audio_path)
        
        return audio_id, audio_path
    
    async def speech_to_text(self, audio_data: bytes) -> str:
        """
        语音转文本 (ASR) - 使用SenseVoice
        
        技术亮点：
        1. 支持多种音频格式
        2. 实时转写，低延迟
        3. 中文识别准确率高
        """
        # 保存临时音频文件
        temp_path = f"./temp_{uuid.uuid4()}.wav"
        with open(temp_path, 'wb') as f:
            f.write(audio_data)
        
        # SenseVoice 识别
        result = self.asr_model.generate(
            input=temp_path,
            language="zh",
            use_itn=True  # 智能文本规整
        )
        
        return result[0]["text"]
```

**代码讲解要点**：
1. **适老化设计**：默认温柔女声 + 音量增大10%
2. **异步处理**：async/await 不阻塞用户交互
3. **双模型架构**：Edge-TTS(合成) + SenseVoice(识别)

---

## 六、LLM 对话服务

### 6.1 技术架构

```
用户输入 → 意图识别 → Prompt构建 → DeepSeek API → 响应解析 → 返回用户
              ↓              ↓
         健康关键词      上下文注入
         检测          (健康数据/知识库)
```

### 6.2 Prompt 工程

**系统提示词设计**：
```python
HEALTH_ASSISTANT_PROMPT = """
你是"小康"，一个专业、亲切的健康管家。

## 角色定位
- 服务对象：老年人（60岁以上）
- 说话风格：亲切、温暖、耐心、简洁
- 专业领域：日常健康咨询、慢病管理、生活方式指导

## 行为准则
1. 使用简单易懂的语言，避免专业术语
2. 多给予鼓励和关心，注重情感支持
3. 涉及严重健康问题时，建议及时就医
4. 不替代医生诊断，不推荐具体药物

## 当前用户信息
用户姓名: {user_name}
最近健康数据: {health_summary}
历史对话: {chat_history}

## 用户问题
{user_input}

请以"小康"的身份，用温暖亲切的语气回答：
"""
```

### 6.3 对话管理

**上下文窗口管理**：
```python
class ConversationManager:
    def __init__(self, max_history=10):
        self.max_history = max_history
        self.conversations = {}
    
    def add_message(self, user_id, role, content):
        if user_id not in self.conversations:
            self.conversations[user_id] = []
        
        self.conversations[user_id].append({
            "role": role,
            "content": content,
            "timestamp": datetime.now().isoformat()
        })
        
        # 保持最近N轮对话
        if len(self.conversations[user_id]) > self.max_history * 2:
            self.conversations[user_id] = self.conversations[user_id][-self.max_history * 2:]
```

---

## 七、适老化设计要点

### 7.1 语音交互适老化

| 设计点 | 实现方式 | 标准依据 |
|--------|----------|----------|
| 语速适中 | rate="+0%" 默认不加速 | GB/T 37668-2019 |
| 音量增大 | volume="+10%" | 工信部适老化规范 |
| 温柔语调 | 默认晓晓女声 | 用户体验研究 |
| 句子分割 | 按标点分段播放 | 认知负荷理论 |

### 7.2 对话交互适老化

| 设计点 | 实现方式 |
|--------|----------|
| 简洁回复 | 控制回复长度在100字以内 |
| 关怀问候 | 根据时段自动问候 |
| 重复确认 | 重要信息重复说明 |
| 耐心引导 | 不催促，给足思考时间 |

---

## 八、API 接口

### 8.1 语音接口

```python
# TTS 语音合成
POST /api/voice/tts
{
    "text": "您好，今天感觉怎么样？",
    "voice": "xiaoxiao",
    "rate": "+0%"
}
# 返回：音频文件URL

# ASR 语音识别
POST /api/voice/asr
Content-Type: multipart/form-data
file: audio.wav
# 返回：{"text": "我今天血压有点高"}
```

### 8.2 AI 对话接口

```python
POST /api/ai/chat
{
    "user_id": "USER001",
    "message": "我血压145/92，高不高？",
    "use_voice": true
}
# 返回：
{
    "text": "您的血压145/92属于1级高血压...",
    "audio_url": "/audio/xxx.mp3",
    "suggestions": ["减少盐分摄入", "适当运动"]
}
```

---

## 九、技术亮点总结

| 亮点 | 说明 |
|------|------|
| **双模型语音架构** | FunASR识别 + Edge-TTS合成，开源免费 |
| **适老化语音设计** | 温柔语音 + 适中语速 + 增大音量 |
| **Prompt工程** | 角色设定 + 行为准则 + 上下文注入 |
| **流式响应** | 支持流式TTS，低延迟播放 |
| **对话记忆** | 多轮对话上下文管理 |

---

## 十、依赖库

```txt
# 语音服务
edge-tts>=6.1.0           # 微软TTS
funasr>=1.0.0             # 阿里ASR

# LLM服务
openai>=1.0.0             # OpenAI API风格调用
httpx                     # 异步HTTP客户端

# Web框架
fastapi>=0.100.0
uvicorn>=0.23.0
python-multipart          # 文件上传
```

---

*文档更新时间: 2025年12月*
*项目: 养生之道智能健康管理系统*
