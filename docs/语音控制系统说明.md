# 语音控制系统说明

## 一、系统架构

```
用户说话
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│  前端：VoiceControlBar.tsx                                   │
│  - Web Speech API 识别语音                                   │
│  - 直接处理命令（无需唤醒词）                                │
│  - 智能打断检测                                              │
└──────────────────┬──────────────────────────────────────────┘
                   │ POST /api/v1/voice-agent/text-command
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  后端：voice_agent.py → text-command 接口                    │
│                                                              │
│  1. 自动化场景匹配 (automation_service.py)                   │
│     → 返回 is_automation=true, frontend_events[]             │
│                                                              │
│  2. 意图识别 (intent_recognizer.py) 【三层混合】             │
│     ├─ 规则匹配：关键词快速匹配                              │
│     ├─ 语义匹配：Sentence-Transformers 理解同义表达          │
│     └─ LLM兜底：复杂情况调用讯飞星火                         │
│                                                              │
│  3. 控制命令解析 (voice_control_service.py)                  │
│     → 返回 is_control=true, control_event, control_data      │
│                                                              │
│  4. 多智能体问答 (multi_agent_service.py)                    │
│     → 返回 response 文本                                     │
│                                                              │
│  + TTS语音合成 (voice_service.py)                            │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ▼
┌─────────────────────────────────────────────────────────────┐
│  前端：handleFrontendEvent() 事件处理                        │
│                                                              │
│  - navigate      → setActiveTab()                            │
│  - query_data    → speak(健康数据)                           │
│  - generate_report → handleGenerateReport()                  │
│  - set_reminder  → alert() 模拟                              │
│  - emergency_call → 紧急呼救通知                             │
│  - stop_speaking → speechSynthesis.cancel()                  │
└─────────────────────────────────────────────────────────────┘
```

---

## 二、已实现的语音命令

### 1. 导航控制
| 语音命令 | 执行动作 |
|----------|----------|
| "打开首页" / "打开健康分析" | 跳转到首页 (analysis) |
| "打开报告" / "打开健康报告" | 跳转到报告页 (reports) |
| "打开心理健康" / "打开心理" | 跳转到心理健康页 (psychology) |
| "打开AI对话" / "打开咨询" | 跳转到AI咨询页 (consultation) |
| "打开个人信息" / "打开设置" | 跳转到个人信息页 (myinfo) |
| "返回" | 返回上一页 |

### 2. 健康数据播报
| 语音命令 | 执行动作 |
|----------|----------|
| "查看血压" / "我的血压" | 语音播报血压数据 |
| "查看血糖" | 语音播报血糖数据 |
| "查看心率" | 语音播报心率数据 |
| "昨晚睡眠" / "睡眠情况" | 语音播报睡眠数据 |
| "今天身体情况" / "健康数据" | 语音播报完整健康摘要 |

### 3. 提醒设置
| 语音命令 | 执行动作 |
|----------|----------|
| "8点提醒我吃药" | 设置8:00吃药提醒 |
| "设置吃药提醒" | 设置吃药提醒 |
| "取消提醒" | 取消提醒 |

### 4. 报告生成
| 语音命令 | 执行动作 |
|----------|----------|
| "生成报告" | 生成健康报告并跳转 |
| "生成健康报告" | 同上 |

### 5. 紧急呼救
| 语音命令 | 执行动作 |
|----------|----------|
| "救命" | 触发紧急呼救通知 |
| "帮帮我" | 触发紧急呼救通知 |
| "不舒服" | 触发紧急呼救通知 |
| "紧急呼救" | 触发紧急呼救通知 |

### 6. 停止语音
| 语音命令 | 执行动作 |
|----------|----------|
| "停止" / "别说了" | 停止语音播报 |
| "取消" | 取消当前操作 |

---

## 三、自动化场景

| 场景名称 | 触发关键词 | 执行流程 |
|----------|-----------|----------|
| **早安模式** | "早安"、"早上好"、"起床了" | 1. 问候 → 2. 播报睡眠 → 3. 播报健康数据 |
| **晚安模式** | "晚安"、"睡觉了" | 1. 问候 → 2. 今日健康总结 |
| **健康播报** | "健康播报"、"身体情况" | 播报当前健康状态摘要 |
| **生成报告** | "生成报告"、"做报告" | 1. 生成报告 → 2. 跳转报告页 |
| **紧急求助** | "救命"、"帮帮我"、"不舒服" | 触发紧急通知 |
| **查看趋势** | "看趋势"、"最近变化" | 1. 跳转健康分析页 → 2. 播报趋势分析 |
| **吃药提醒** | "该吃药了"、"吃药时间" | 播报用药清单 |

---

## 四、使用方法

1. 点击顶部栏的"语音助手"按钮开始监听
2. 按钮变绿色（🎤 聆听中）表示正在监听
3. 直接说出命令（如"打开报告"、"查看血压"）
4. 系统识别后自动执行并语音回复
5. 再次点击按钮停止监听
6. 点击"播报"按钮可朗读当前健康数据

---

## 五、未实现功能（已删除）

以下功能因技术限制暂未实现：
- ❌ 打电话（需要电话系统集成）
- ❌ 设备测量（需要蓝牙硬件连接）
- ❌ 音乐/视频播放（需要媒体播放器）
- ❌ 音量控制（需要系统级权限）
- ❌ 发送报告给家人（需要推送服务）

---

## 六、相关文件

### 后端
- `backend/services/voice_control_service.py` - 语音控制命令解析
- `backend/services/automation_service.py` - 自动化场景服务
- `backend/api/routes/voice_agent.py` - 语音智能体API
- `backend/services/voice_service.py` - TTS语音合成

### 前端
- `frontend/src/components/elderly/VoiceControlBar.tsx` - 语音控制栏组件
- `frontend/src/App.tsx` - 主应用（事件处理回调）
- `frontend/src/contexts/VoiceContext.tsx` - 语音上下文

---

*文档更新时间: 2024-12-09*
