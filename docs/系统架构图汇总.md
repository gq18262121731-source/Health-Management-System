# 养生之道 - 系统架构图汇总

> 智慧健康管理系统全模块架构说明

---

## 一、项目整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│                              养生之道 智慧健康管理系统                               │
│                                                                                     │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                            前端展示层 (React)                              │    │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │    │
│   │  │  健康数据    │ │  健康报告   │ │  语音助手   │ │  可视化图表         │  │    │
│   │  │  录入页面    │ │  查看页面   │ │  交互界面   │ │  (ECharts)          │  │    │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘  │    │
│   └───────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                          │
│                                         │ HTTP/WebSocket                           │
│                                         ▼                                          │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                            后端服务层 (FastAPI)                            │    │
│   │                                                                           │    │
│   │  ┌─────────────────────────────────────────────────────────────────────┐  │    │
│   │  │                         API 路由层                                   │  │    │
│   │  │  /api/iot/*     /api/health/*   /api/v1/voice-agent/*   /api/v1/ai/* │  │    │
│   │  │  数据采集        健康数据         语音智能体            AI问答        │  │    │
│   │  └─────────────────────────────────────────────────────────────────────┘  │    │
│   │                                    │                                      │    │
│   │         ┌──────────────────────────┼──────────────────────────┐           │    │
│   │         ▼                          ▼                          ▼           │    │
│   │  ┌─────────────┐          ┌─────────────────┐          ┌─────────────┐   │    │
│   │  │  数据采集   │          │   多智能体系统   │          │  语音服务   │   │    │
│   │  │  流水线     │          │   (4个专家+1协调)│          │  ASR + TTS  │   │    │
│   │  └──────┬──────┘          └────────┬────────┘          └──────┬──────┘   │    │
│   │         │                          │                          │          │    │
│   │         ▼                          ▼                          ▼          │    │
│   │  ┌─────────────┐          ┌─────────────────┐          ┌─────────────┐   │    │
│   │  │  健康评估   │          │   RAG知识库     │          │  意图识别   │   │    │
│   │  │  引擎       │          │   FAISS+m3e     │          │  三层匹配   │   │    │
│   │  └─────────────┘          └─────────────────┘          └─────────────┘   │    │
│   └───────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                          │
│                                         ▼                                          │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                            数据存储层                                      │    │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │    │
│   │  │  SQLite     │ │  内存缓存   │ │  FAISS      │ │  文件存储           │  │    │
│   │  │  用户数据   │ │  实时数据   │ │  向量索引   │ │  音频/文档          │  │    │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘  │    │
│   └───────────────────────────────────────────────────────────────────────────┘    │
│                                         │                                          │
│                                         ▼                                          │
│   ┌───────────────────────────────────────────────────────────────────────────┐    │
│   │                            物联网感知层                                    │    │
│   │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────┐  │    │
│   │  │  STM32 +    │ │  血压计     │ │  体温计     │ │  智能手环           │  │    │
│   │  │  MAX30102   │ │  模块       │ │  模块       │ │  (可扩展)           │  │    │
│   │  │  心率血氧   │ │             │ │             │ │                     │  │    │
│   │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────────┘  │    │
│   └───────────────────────────────────────────────────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、数据采集模块架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            数据采集模块                                     │
│                                                                            │
│                    ┌─────────────────────────────┐                         │
│                    │      物联网传感器层          │                         │
│                    │   STM32 + MAX30102 心率模块  │                         │
│                    └──────────────┬──────────────┘                         │
│                                   │                                        │
│                                   │ WiFi 发送 HTTP POST                    │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                     后端接口层 (FastAPI)                          │   │
│    │                                                                  │   │
│    │    第一步：数据校验                                               │   │
│    │    ├── 心率范围: 30 ~ 220 次/分                                   │   │
│    │    ├── 血氧范围: 70% ~ 100%                                      │   │
│    │    └── 必填字段: device_id                                       │   │
│    │                                                                  │   │
│    │    第二步：设备绑定查询                                           │   │
│    │    └── device_id → user_id (如: STM32_001 → 张大爷)              │   │
│    │                                                                  │   │
│    │    第三步：异常告警检测                                           │   │
│    │    ├── 心率 < 50 → "心率过缓"                                    │   │
│    │    ├── 心率 > 100 → "心率过速"                                   │   │
│    │    └── 血氧 < 94% → "血氧偏低"                                   │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                     ┌─────────────┴─────────────┐                          │
│                     ▼                           ▼                          │
│    ┌──────────────────────────┐   ┌──────────────────────────┐            │
│    │      内存缓存             │   │    数据清洗流水线         │            │
│    │   (快速查询)              │   │    (持久化存储)          │            │
│    │                          │   │                          │            │
│    │   • 最近 1000 条数据     │   │   1. 去重处理            │            │
│    │   • WebSocket 实时推送   │   │   2. 异常值检测          │            │
│    │   • 查询接口             │   │   3. 缺失值填充          │            │
│    │                          │   │   4. 数据标准化          │            │
│    └──────────────────────────┘   └─────────────┬────────────┘            │
│                                                  │                         │
│                                                  ▼                         │
│                                   ┌──────────────────────────┐            │
│                                   │       数据存储层          │            │
│                                   │    SQLite / MySQL        │            │
│                                   └──────────────────────────┘            │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、数据清洗模块架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            数据清洗模块                                     │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      原始数据输入                                 │   │
│    │   RawDataRecord { user_id, data_type, timestamp, values }        │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第一步：去重处理                                │   │
│    │                                                                  │   │
│    │   • 时间戳去重: 同一用户同一分钟内的重复数据                       │   │
│    │   • 相似记录合并: 数值差异 < 5% 的连续记录                        │   │
│    │   • 生成唯一 record_id (MD5哈希)                                 │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第二步：异常值检测                              │   │
│    │                                                                  │   │
│    │   方法一: IQR法 (四分位距)                                        │   │
│    │   └── 异常值 = 值 < Q1-1.5*IQR 或 值 > Q3+1.5*IQR                │   │
│    │                                                                  │   │
│    │   方法二: Z-score法 (标准差)                                      │   │
│    │   └── 异常值 = |Z分数| > 3                                       │   │
│    │                                                                  │   │
│    │   方法三: 业务规则                                                │   │
│    │   └── 心率 < 30 或 > 220 直接标记为异常                          │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第三步：缺失值填充                              │   │
│    │                                                                  │   │
│    │   • 前向填充: 用前一个有效值填充                                  │   │
│    │   • 后向填充: 用后一个有效值填充                                  │   │
│    │   • 线性插值: 根据前后值计算中间值                                │   │
│    │   • 均值填充: 用该用户历史均值填充                                │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第四步：数据标准化                              │   │
│    │                                                                  │   │
│    │   Min-Max归一化: x' = (x - min) / (max - min)                    │   │
│    │   Z-score标准化: x' = (x - μ) / σ                                │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      清洗后数据输出                               │   │
│    │   CleanedDataRecord { value, quality_flags, cleaning_applied }   │   │
│    └──────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、健康评估模块架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            健康评估模块                                     │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      多维度健康数据输入                           │   │
│    │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐  │   │
│    │  │ 血压数据 │ │ 血糖数据 │ │ 心率数据 │ │ 睡眠数据 │ │运动数据│  │   │
│    │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘ └───┬────┘  │   │
│    └───────┼────────────┼────────────┼────────────┼───────────┼───────┘   │
│            └────────────┴────────────┼────────────┴───────────┘           │
│                                      ▼                                     │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第一步：单项评估                                │   │
│    │                                                                  │   │
│    │   血压评估 ──→ 根据《中国高血压防治指南》                         │   │
│    │   ├── 正常: 收缩压 < 120 且 舒张压 < 80                          │   │
│    │   ├── 正常高值: 120-139 / 80-89                                  │   │
│    │   ├── 高血压1级: 140-159 / 90-99                                 │   │
│    │   └── 高血压2级: ≥160 / ≥100                                     │   │
│    │                                                                  │   │
│    │   血糖评估 ──→ 空腹/餐后分别判断                                  │   │
│    │   ├── 正常: 空腹 < 6.1, 餐后 < 7.8                               │   │
│    │   ├── 糖尿病前期: 空腹 6.1-7.0, 餐后 7.8-11.1                    │   │
│    │   └── 糖尿病: 空腹 ≥ 7.0 或 餐后 ≥ 11.1                          │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第二步：模糊逻辑评估                            │   │
│    │                                                                  │   │
│    │   输入值 ──→ 模糊化 ──→ 规则推理 ──→ 去模糊化 ──→ 评估分数       │   │
│    │                                                                  │   │
│    │   示例: 血压 = 145/92                                            │   │
│    │   ├── 模糊化: μ(正常)=0.2, μ(偏高)=0.7, μ(高)=0.3               │   │
│    │   ├── 规则推理: IF 血压偏高 THEN 风险中等                         │   │
│    │   └── 去模糊化: 风险分数 = 65分                                   │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第三步：AHP权重计算                             │   │
│    │                                                                  │   │
│    │   层次分析法确定各指标权重:                                       │   │
│    │   ┌────────────┬────────────┬────────────┬────────────┐          │   │
│    │   │   血压     │   血糖     │   心率     │   睡眠     │          │   │
│    │   │  权重 30%  │  权重 25%  │  权重 20%  │  权重 15%  │          │   │
│    │   └────────────┴────────────┴────────────┴────────────┘          │   │
│    │                                                                  │   │
│    │   一致性检验: CR < 0.1 (通过)                                     │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第四步：综合评分输出                            │   │
│    │                                                                  │   │
│    │   综合健康分数 = Σ (单项分数 × 权重)                              │   │
│    │                                                                  │   │
│    │   输出结果:                                                       │   │
│    │   ├── 综合健康分数: 78/100                                       │   │
│    │   ├── 健康等级: 良好                                              │   │
│    │   ├── TOP3 风险因素: 血压偏高、睡眠不足、运动量少                  │   │
│    │   └── 改善建议: 控盐饮食、增加有氧运动、保证7小时睡眠             │   │
│    └──────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、多智能体系统架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            多智能体系统                                     │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      用户问题输入                                 │   │
│    │   "我血压有点高，最近睡眠也不好，心情有点烦躁"                      │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   智能体协调器 (AgentCoordinator)                 │   │
│    │                                                                  │   │
│    │   第一步：意图识别 (三层匹配)                                     │   │
│    │   ├── 规则匹配: 关键词检测 (血压、睡眠、心情)                      │   │
│    │   ├── 语义匹配: Sentence-Transformers 相似度                      │   │
│    │   └── LLM兜底: DeepSeek 理解复杂意图                              │   │
│    │                                                                  │   │
│    │   第二步：置信度计算                                              │   │
│    │   ┌────────────────┬───────────────┬───────────────┬──────────┐  │   │
│    │   │  慢病专家      │  生活教练     │  心理关怀     │ 通用助手 │  │   │
│    │   │  置信度: 50%   │  置信度: 30%  │  置信度: 20%  │  0%      │  │   │
│    │   └────────────────┴───────────────┴───────────────┴──────────┘  │   │
│    │                                                                  │   │
│    │   第三步：智能路由                                                │   │
│    │   └── 选择置信度最高的智能体处理                                  │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│         ┌─────────────────────────┼─────────────────────────┐              │
│         ▼                         ▼                         ▼              │
│    ┌──────────┐            ┌──────────┐            ┌──────────┐           │
│    │ 慢病专家 │            │ 生活教练 │            │ 心理关怀 │           │
│    │          │            │          │            │          │           │
│    │ 擅长:    │            │ 擅长:    │            │ 擅长:    │           │
│    │ 高血压   │            │ 睡眠调节 │            │ 情绪疏导 │           │
│    │ 糖尿病   │            │ 运动指导 │            │ 心理支持 │           │
│    │ 心血管   │            │ 饮食建议 │            │ 压力缓解 │           │
│    └────┬─────┘            └────┬─────┘            └────┬─────┘           │
│         │                       │                       │                  │
│         └───────────────────────┼───────────────────────┘                  │
│                                 ▼                                          │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   RAG知识库增强                                   │   │
│    │                                                                  │   │
│    │   向量检索引擎: FAISS                                             │   │
│    │   嵌入模型: m3e-base (中文优化)                                   │   │
│    │                                                                  │   │
│    │   知识来源:                                                       │   │
│    │   ├── 《中国高血压防治指南》                                      │   │
│    │   ├── 《中国糖尿病防治指南》                                      │   │
│    │   ├── 《中国居民膳食指南》                                        │   │
│    │   └── 专业医学文献库                                              │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   LLM生成回复 (DeepSeek/讯飞星火)                 │   │
│    │                                                                  │   │
│    │   Prompt = 系统角色 + RAG检索结果 + 用户问题                      │   │
│    │                                                                  │   │
│    │   生成专业、温暖、可溯源的健康建议                                 │   │
│    └──────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、语音交互系统架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            语音交互系统                                     │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      用户语音输入                                 │   │
│    │   "我想问一下血压高怎么办"                                        │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第一步：语音识别 (ASR)                          │   │
│    │                                                                  │   │
│    │   讯飞语音识别 API                                                │   │
│    │   ├── 输入: 音频流 (WAV/PCM)                                     │   │
│    │   ├── 输出: 文本 "我想问一下血压高怎么办"                         │   │
│    │   └── 支持: 流式识别、中文方言                                    │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第二步：意图识别 (三层匹配)                      │   │
│    │                                                                  │   │
│    │   ┌────────────────────────────────────────────────────────┐     │   │
│    │   │  第1层: 规则匹配                                        │     │   │
│    │   │  关键词检测: "血压" → 慢病咨询类                         │     │   │
│    │   │  置信度 > 0.8 → 直接返回                                │     │   │
│    │   └────────────────────────────────────────────────────────┘     │   │
│    │                          │ 置信度不足                             │   │
│    │                          ▼                                        │   │
│    │   ┌────────────────────────────────────────────────────────┐     │   │
│    │   │  第2层: 语义匹配                                        │     │   │
│    │   │  Sentence-Transformers 语义相似度                       │     │   │
│    │   │  与预定义意图模板比较                                    │     │   │
│    │   │  置信度 > 0.7 → 返回匹配结果                            │     │   │
│    │   └────────────────────────────────────────────────────────┘     │   │
│    │                          │ 置信度不足                             │   │
│    │                          ▼                                        │   │
│    │   ┌────────────────────────────────────────────────────────┐     │   │
│    │   │  第3层: LLM兜底                                         │     │   │
│    │   │  调用 DeepSeek 理解复杂/模糊意图                         │     │   │
│    │   │  返回意图分类 + 实体提取                                 │     │   │
│    │   └────────────────────────────────────────────────────────┘     │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第三步：智能体处理                              │   │
│    │                                                                  │   │
│    │   路由到对应智能体 (慢病专家/生活教练/心理关怀/通用助手)          │   │
│    │   结合 RAG 知识库生成回复                                        │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第四步：语音合成 (TTS)                          │   │
│    │                                                                  │   │
│    │   讯飞语音合成 API                                                │   │
│    │   ├── 输入: 回复文本                                             │   │
│    │   ├── 输出: 音频流                                               │   │
│    │   └── 支持: 多种音色、语速调节                                    │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      语音输出给用户                               │   │
│    │   "根据《中国高血压防治指南》，建议您控制盐分摄入..."              │   │
│    └──────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、RAG知识库架构图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            RAG知识库系统                                    │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      知识文档来源                                 │   │
│    │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────────┐ │   │
│    │  │ 高血压   │ │ 糖尿病   │ │ 膳食     │ │ 其他医学文献         │ │   │
│    │  │ 防治指南 │ │ 防治指南 │ │ 指南     │ │ (PDF/TXT/MD)         │ │   │
│    │  └────┬─────┘ └────┬─────┘ └────┬─────┘ └──────────┬───────────┘ │   │
│    └───────┼────────────┼────────────┼──────────────────┼─────────────┘   │
│            └────────────┴────────────┼──────────────────┘                  │
│                                      ▼                                     │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第一步：文档预处理                              │   │
│    │                                                                  │   │
│    │   • 文档解析: PDF/Word/Markdown 转纯文本                          │   │
│    │   • 文本分块: 按段落或固定长度切分 (chunk_size=500)               │   │
│    │   • 元数据提取: 来源、章节、页码                                  │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第二步：向量化 (Embedding)                      │   │
│    │                                                                  │   │
│    │   嵌入模型: m3e-base (中文语义优化)                               │   │
│    │   ├── 输入: 文本块 "高血压患者应控制每日盐摄入量..."               │   │
│    │   └── 输出: 768维向量 [0.12, -0.34, 0.56, ...]                   │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第三步：向量存储 (FAISS)                        │   │
│    │                                                                  │   │
│    │   索引类型: IndexFlatIP (内积相似度)                              │   │
│    │   存储内容:                                                       │   │
│    │   ┌────────────────────────────────────────────────────────┐     │   │
│    │   │  向量ID  │  文本内容                    │  来源          │     │   │
│    │   ├──────────┼─────────────────────────────┼────────────────┤     │   │
│    │   │  001     │  高血压患者应控制盐摄入...   │  高血压指南P12 │     │   │
│    │   │  002     │  每日食盐不超过6克...        │  高血压指南P12 │     │   │
│    │   │  003     │  糖尿病空腹血糖标准...       │  糖尿病指南P8  │     │   │
│    │   └──────────┴─────────────────────────────┴────────────────┘     │   │
│    └──────────────────────────────────────────────────────────────────┘   │
│                                                                            │
│    ════════════════════════ 查询时流程 ════════════════════════════════   │
│                                                                            │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                      用户问题                                     │   │
│    │   "血压高应该怎么控制饮食？"                                       │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第四步：问题向量化                              │   │
│    │                                                                  │   │
│    │   m3e-base 编码问题 → 768维查询向量                               │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第五步：相似度检索                              │   │
│    │                                                                  │   │
│    │   FAISS.search(查询向量, top_k=5)                                 │   │
│    │                                                                  │   │
│    │   返回最相似的5个文档块:                                          │   │
│    │   ├── [相似度0.92] "高血压患者应控制盐摄入..."                    │   │
│    │   ├── [相似度0.88] "每日食盐不超过6克..."                         │   │
│    │   └── [相似度0.85] "建议增加钾摄入..."                            │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第六步：构建增强Prompt                          │   │
│    │                                                                  │   │
│    │   Prompt = """                                                   │   │
│    │   你是健康顾问，根据以下参考资料回答问题：                         │   │
│    │                                                                  │   │
│    │   【参考资料】                                                    │   │
│    │   1. 高血压患者应控制盐摄入... (来源：高血压指南P12)              │   │
│    │   2. 每日食盐不超过6克... (来源：高血压指南P12)                   │   │
│    │                                                                  │   │
│    │   【用户问题】                                                    │   │
│    │   血压高应该怎么控制饮食？                                        │   │
│    │   """                                                            │   │
│    └──────────────────────────────┬───────────────────────────────────┘   │
│                                   │                                        │
│                                   ▼                                        │
│    ┌──────────────────────────────────────────────────────────────────┐   │
│    │                   第七步：LLM生成回复                             │   │
│    │                                                                  │   │
│    │   调用 DeepSeek/讯飞星火 生成回复                                 │   │
│    │   回复中引用知识来源，确保可溯源                                  │   │
│    └──────────────────────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、模块间数据流向总图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                                                                 │
│                              系统数据流向总图                                    │
│                                                                                 │
│   ┌─────────────┐                                      ┌─────────────────────┐ │
│   │  IoT传感器  │                                      │     用户语音输入    │ │
│   │  STM32      │                                      │                     │ │
│   └──────┬──────┘                                      └──────────┬──────────┘ │
│          │                                                        │            │
│          │ HTTP                                                   │ 音频       │
│          ▼                                                        ▼            │
│   ┌─────────────────────────────────────────────────────────────────────────┐ │
│   │                            FastAPI 后端                                  │ │
│   │  ┌─────────────┐      ┌─────────────┐      ┌─────────────────────────┐  │ │
│   │  │ /api/iot/*  │      │ /api/health │      │ /api/v1/voice-agent/*  │  │ │
│   │  │ 数据采集    │      │ 健康数据    │      │ 语音智能体              │  │ │
│   │  └──────┬──────┘      └──────┬──────┘      └────────────┬────────────┘  │ │
│   └─────────┼─────────────────────┼─────────────────────────┼───────────────┘ │
│             │                     │                         │                  │
│             ▼                     ▼                         ▼                  │
│   ┌─────────────────┐   ┌─────────────────┐   ┌─────────────────────────────┐ │
│   │                 │   │                 │   │                             │ │
│   │   数据清洗      │   │   健康评估      │   │   语音服务                  │ │
│   │   流水线        │   │   引擎          │   │   ASR → 意图识别 → TTS      │ │
│   │                 │   │                 │   │                             │ │
│   │  • 去重         │   │  • 单项评估     │   │  • 讯飞语音识别             │ │
│   │  • 异常检测     │   │  • 模糊逻辑     │   │  • 三层意图匹配             │ │
│   │  • 缺失填充     │   │  • AHP权重      │   │  • 讯飞语音合成             │ │
│   │  • 标准化       │   │  • 综合评分     │   │                             │ │
│   │                 │   │                 │   │                             │ │
│   └────────┬────────┘   └────────┬────────┘   └──────────────┬──────────────┘ │
│            │                     │                           │                 │
│            └──────────┬──────────┘                           │                 │
│                       │                                      │                 │
│                       ▼                                      ▼                 │
│            ┌─────────────────────────────────────────────────────────────┐    │
│            │                                                             │    │
│            │                    多智能体系统                              │    │
│            │                                                             │    │
│            │   ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐      │    │
│            │   │ 慢病专家 │ │ 生活教练 │ │ 心理关怀 │ │ 通用助手 │      │    │
│            │   └────┬─────┘ └────┬─────┘ └────┬─────┘ └────┬─────┘      │    │
│            │        └────────────┼────────────┼────────────┘            │    │
│            │                     ▼            ▼                         │    │
│            │              ┌─────────────────────────┐                   │    │
│            │              │    RAG知识库            │                   │    │
│            │              │    FAISS + m3e-base     │                   │    │
│            │              └────────────┬────────────┘                   │    │
│            │                           │                                │    │
│            │                           ▼                                │    │
│            │              ┌─────────────────────────┐                   │    │
│            │              │    LLM 生成回复         │                   │    │
│            │              │    DeepSeek/讯飞星火    │                   │    │
│            │              └─────────────────────────┘                   │    │
│            │                                                             │    │
│            └─────────────────────────────────────────────────────────────┘    │
│                                         │                                      │
│                                         ▼                                      │
│            ┌─────────────────────────────────────────────────────────────┐    │
│            │                       数据存储层                             │    │
│            │                                                             │    │
│            │   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │    │
│            │   │ SQLite   │  │ 内存缓存 │  │ FAISS    │  │ 文件存储 │   │    │
│            │   │ 用户数据 │  │ 实时数据 │  │ 向量索引 │  │ 知识文档 │   │    │
│            │   └──────────┘  └──────────┘  └──────────┘  └──────────┘   │    │
│            └─────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、技术栈汇总

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **前端** | React + ECharts | 健康数据可视化 |
| **后端** | FastAPI + Python 3.10 | 异步高性能API |
| **数据采集** | Pydantic | 数据校验与模型 |
| **数据清洗** | Pandas + NumPy | 数据处理流水线 |
| **健康评估** | 模糊逻辑 + AHP | 多维度评估算法 |
| **智能体** | 自研多Agent架构 | 4专家+1协调器 |
| **意图识别** | 规则+语义+LLM三层 | Sentence-Transformers |
| **知识库** | FAISS + m3e-base | 向量检索RAG |
| **语音服务** | 讯飞ASR/TTS | 语音识别与合成 |
| **LLM** | DeepSeek / 讯飞星火 | 大语言模型 |
| **IoT** | STM32 + MAX30102 | 心率血氧传感器 |
| **数据库** | SQLite / MySQL | 数据持久化 |
