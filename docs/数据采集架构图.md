# 数据采集层架构图

## 核心流程图

```
                           ┌────────────────────────────────┐
                           │        物联网传感器层           │
                           │   (STM32 + MAX30102 心率模块)   │
                           └───────────────┬────────────────┘
                                           │
                                           │ 通过 WiFi/ESP8266 发送
                                           │ HTTP POST 请求
                                           ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                                                                              │
│                           后端接口层 (FastAPI)                                │
│                                                                              │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                                                                  │     │
│    │   接口地址: POST /api/iot/vitals/upload                          │     │
│    │                                                                  │     │
│    │   请求数据: {"heart_rate": 78, "spo2": 98, "device_id": "001"}  │     │
│    │                                                                  │     │
│    └──────────────────────────────────────────────────────────────────┘     │
│                                           │                                  │
│                                           ▼                                  │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                       第一步：数据校验                            │     │
│    │                                                                  │     │
│    │   • 心率范围检查: 30 ~ 220 次/分                                  │     │
│    │   • 血氧范围检查: 70% ~ 100%                                     │     │
│    │   • 必填字段检查: device_id 不能为空                              │     │
│    │                                                                  │     │
│    │   校验失败 → 返回 400 错误                                        │     │
│    │   校验通过 → 继续处理                                             │     │
│    └──────────────────────────────────────────────────────────────────┘     │
│                                           │                                  │
│                                           ▼                                  │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                       第二步：设备绑定查询                         │     │
│    │                                                                  │     │
│    │   根据 device_id 查找对应的 user_id                               │     │
│    │                                                                  │     │
│    │   例如: "STM32_001" → "elderly_001" (张大爷)                      │     │
│    │                                                                  │     │
│    │   未绑定设备 → 暂存为 unknown_user                                 │     │
│    └──────────────────────────────────────────────────────────────────┘     │
│                                           │                                  │
│                                           ▼                                  │
│    ┌──────────────────────────────────────────────────────────────────┐     │
│    │                       第三步：异常告警检测                         │     │
│    │                                                                  │     │
│    │   • 心率 < 50  → 告警: "心率过缓"                                 │     │
│    │   • 心率 > 100 → 告警: "心率过速"                                 │     │
│    │   • 血氧 < 94% → 告警: "血氧偏低，请注意！"                        │     │
│    │                                                                  │     │
│    └──────────────────────────────────────────────────────────────────┘     │
│                                           │                                  │
└───────────────────────────────────────────┼──────────────────────────────────┘
                                            │
                          ┌─────────────────┴─────────────────┐
                          │                                   │
                          ▼                                   ▼
┌─────────────────────────────────────┐   ┌─────────────────────────────────────┐
│                                     │   │                                     │
│         路径一：内存缓存             │   │       路径二：数据清洗流水线         │
│         (快速查询使用)               │   │       (持久化存储)                  │
│                                     │   │                                     │
│   存入最近 1000 条数据              │   │   调用 DataCollector.collect_single │
│   用于实时查询和 WebSocket 推送     │   │                                     │
│                                     │   │   数据进入清洗流水线:               │
│   查询接口:                         │   │   ┌─────────────────────────────┐   │
│   GET /api/iot/vitals/latest        │   │   │ 1. 去重 (时间戳去重)        │   │
│                                     │   │   │ 2. 异常值检测 (IQR/Z分数)  │   │
└─────────────────────────────────────┘   │   │ 3. 缺失值填充 (线性插值)   │   │
                                          │   │ 4. 数据标准化               │   │
                                          │   └─────────────────────────────┘   │
                                          │                                     │
                                          │   生成 RawDataRecord 记录:          │
                                          │   • record_id: 唯一标识             │
                                          │   • user_id: 关联用户               │
                                          │   • source: SENSOR (传感器)         │
                                          │                                     │
                                          └─────────────────────────────────────┘
                                                            │
                                                            ▼
                                          ┌─────────────────────────────────────┐
                                          │                                     │
                                          │           数据存储层                │
                                          │                                     │
                                          │   • SQLite/MySQL 持久化存储         │
                                          │   • 支持历史数据查询                 │
                                          │   • 支持健康报告生成                 │
                                          │                                     │
                                          └─────────────────────────────────────┘
```

---

## 一、整体数据流

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数 据 采 集 层                                      │
│                                                                                  │
│   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐     │
│   │  STM32 +     │   │   手动输入    │   │  批量导入    │   │  第三方API   │     │
│   │  MAX30102    │   │   (表单)     │   │ (CSV/JSON)  │   │  (微信/医院) │     │
│   │  ─────────   │   │  ─────────   │   │  ─────────   │   │  ─────────   │     │
│   │  心率 血氧   │   │  血压 血糖   │   │  历史数据    │   │  体检报告    │     │
│   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘   └──────┬───────┘     │
│          │                  │                  │                  │              │
│          │ HTTP POST        │ 前端表单         │ 文件上传          │ API调用       │
│          ▼                  ▼                  ▼                  ▼              │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        FastAPI 后端接口                                  │   │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐          │   │
│   │  │ /api/iot/vitals │  │ /api/health/*   │  │ /api/import/*   │          │   │
│   │  │    /upload      │  │                 │  │                 │          │   │
│   │  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘          │   │
│   └───────────┼─────────────────────┼─────────────────────┼─────────────────┘   │
│               │                     │                     │                     │
│               └─────────────────────┼─────────────────────┘                     │
│                                     ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      Pydantic 数据校验                                   │   │
│   │  ┌───────────────────────────────────────────────────────────────────┐  │   │
│   │  │  • 心率范围: 30-220 BPM                                            │  │   │
│   │  │  • 血压范围: 收缩压 60-250, 舒张压 40-150 mmHg                      │  │   │
│   │  │  • 血氧范围: 70-100%                                               │  │   │
│   │  │  • 血糖范围: 1.0-35.0 mmol/L                                       │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
└─────────────────────────────────────┼───────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数 据 处 理 层                                      │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      DataCollector 数据采集器                            │   │
│   │  ┌───────────────────────────────────────────────────────────────────┐  │   │
│   │  │  collect_single()  ──→  数据验证 + 生成唯一ID + 加入缓冲区          │  │   │
│   │  │  collect_batch()   ──→  批量处理多条记录                           │  │   │
│   │  │  import_from_csv() ──→  CSV文件解析导入                            │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      RawDataRecord 原始记录                              │   │
│   │  ┌───────────────────────────────────────────────────────────────────┐  │   │
│   │  │  record_id: "a1b2c3d4"         # MD5生成的唯一ID                   │  │   │
│   │  │  user_id: "elderly_001"        # 用户ID                           │  │   │
│   │  │  data_type: "heart_rate"       # 数据类型                          │  │   │
│   │  │  timestamp: 2024-12-09 08:30   # 采集时间                          │  │   │
│   │  │  values: {value: 78}           # 数据值                            │  │   │
│   │  │  source: SENSOR                # 来源: 传感器                       │  │   │
│   │  │  device_id: "STM32_001"        # 设备ID                            │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      DataCleaner 数据清洗器                              │   │
│   │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │   │
│   │  │   去重       │  │  异常值检测   │  │  缺失值填充   │  │   标准化     │ │   │
│   │  │  ────────    │  │  ──────────   │  │  ──────────   │  │  ────────    │ │   │
│   │  │  时间戳去重  │  │  IQR/Z-score │  │  前向/后向填充 │  │  Min-Max    │ │   │
│   │  │  相似合并    │  │  业务规则     │  │  线性插值     │  │  Z-score    │ │   │
│   │  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘ │   │
│   └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                     │                                           │
│                                     ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                      CleanedDataRecord 清洗后记录                        │   │
│   │  ┌───────────────────────────────────────────────────────────────────┐  │   │
│   │  │  value: 78.0                   # 标准化后的数值                     │  │   │
│   │  │  quality_flags: ["validated"]  # 质量标记                          │  │   │
│   │  │  cleaning_applied: ["zscore"]  # 应用的清洗方法                     │  │   │
│   │  └───────────────────────────────────────────────────────────────────┘  │   │
│   └─────────────────────────────────┬───────────────────────────────────────┘   │
│                                     │                                           │
└─────────────────────────────────────┼───────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数 据 存 储 层                                      │
│                                                                                  │
│   ┌──────────────────┐    ┌──────────────────┐    ┌──────────────────┐          │
│   │   内存缓存        │    │   SQLite/MySQL   │    │   时序数据库      │          │
│   │   (快速查询)      │    │   (持久化)       │    │   (InfluxDB)     │          │
│   └──────────────────┘    └──────────────────┘    └──────────────────┘          │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、STM32 数据上传流程

```
    STM32 + MAX30102                    FastAPI 后端                      数据流水线
    ═══════════════                    ════════════                      ══════════
          │                                 │                                 │
          │  I²C 读取传感器                  │                                 │
          ▼                                 │                                 │
    ┌───────────┐                           │                                 │
    │ 心率: 78  │                           │                                 │
    │ 血氧: 98% │                           │                                 │
    └─────┬─────┘                           │                                 │
          │                                 │                                 │
          │  ESP8266 WiFi                   │                                 │
          │  HTTP POST                      │                                 │
          ▼                                 ▼                                 │
    ┌─────────────────────────────────────────────────────┐                   │
    │ POST /api/iot/vitals/upload                         │                   │
    │ {"heart_rate": 78, "spo2": 98, "device_id": "001"}  │                   │
    └─────────────────────────────────────────────────────┘                   │
                                            │                                 │
                                            ▼                                 │
                                    ┌───────────────┐                         │
                                    │ Pydantic 校验  │                         │
                                    │ 30 ≤ HR ≤ 220 │                         │
                                    │ 70 ≤ SpO2 ≤ 100│                         │
                                    └───────┬───────┘                         │
                                            │                                 │
                              ┌─────────────┴─────────────┐                   │
                              ▼                           ▼                   │
                     ┌────────────────┐          ┌────────────────┐           │
                     │   内存缓存      │          │ DataCollector  │           │
                     │ (最近1000条)   │          │ collect_single │           │
                     └────────────────┘          └────────┬───────┘           │
                                                          │                   │
                                                          ▼                   ▼
                                                 ┌────────────────────────────────┐
                                                 │      设备绑定查询               │
                                                 │  device_id → user_id           │
                                                 │  "STM32_001" → "elderly_001"   │
                                                 └────────────────┬───────────────┘
                                                                  │
                                                                  ▼
                                                 ┌────────────────────────────────┐
                                                 │      RawDataRecord 生成         │
                                                 │  record_id = MD5(...)          │
                                                 │  source = SENSOR               │
                                                 └────────────────┬───────────────┘
                                                                  │
                                                                  ▼
                                                 ┌────────────────────────────────┐
                                                 │      进入清洗流水线              │
                                                 │  去重 → 异常检测 → 标准化        │
                                                 └────────────────────────────────┘
```

---

## 三、设备绑定流程

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                              设备绑定管理                                     │
│                                                                               │
│   1. 绑定设备                                                                 │
│   ────────────                                                                │
│   POST /api/iot/devices/bind                                                  │
│   {"device_id": "STM32_MAX30102_001", "user_id": "elderly_001"}              │
│                                                                               │
│                              ▼                                                │
│                                                                               │
│   ┌─────────────────────────────────────────────────────────────────────┐    │
│   │                    设备绑定表 (_device_user_mapping)                  │    │
│   │  ┌────────────────────────┬─────────────────┐                        │    │
│   │  │       device_id        │     user_id     │                        │    │
│   │  ├────────────────────────┼─────────────────┤                        │    │
│   │  │  STM32_MAX30102_001    │  elderly_001    │                        │    │
│   │  │  STM32_MAX30102_002    │  elderly_002    │                        │    │
│   │  │  BP_MONITOR_001        │  elderly_001    │                        │    │
│   │  └────────────────────────┴─────────────────┘                        │    │
│   └─────────────────────────────────────────────────────────────────────┘    │
│                                                                               │
│   2. 数据上传时自动关联                                                        │
│   ────────────────────────                                                    │
│   upload_vitals(device_id="STM32_MAX30102_001")                              │
│        │                                                                      │
│        ▼                                                                      │
│   get_user_by_device("STM32_MAX30102_001") → "elderly_001"                   │
│        │                                                                      │
│        ▼                                                                      │
│   DataCollector.collect_single(user_id="elderly_001", ...)                   │
│                                                                               │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、数据类型与校验规则

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据类型定义 (DATA_SCHEMAS)                         │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ blood_pressure (血压)                                                    │    │
│  │   必填: systolic, diastolic                                              │    │
│  │   可选: pulse, position, arm                                             │    │
│  │   范围: systolic [60, 250], diastolic [40, 150]                         │    │
│  │   单位: mmHg                                                             │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ heart_rate (心率)                                                        │    │
│  │   必填: value                                                            │    │
│  │   可选: activity_level, resting                                          │    │
│  │   范围: [30, 220]                                                        │    │
│  │   单位: BPM                                                              │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ spo2 (血氧)                                                              │    │
│  │   必填: value                                                            │    │
│  │   可选: perfusion_index                                                  │    │
│  │   范围: [70, 100]                                                        │    │
│  │   单位: %                                                                │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ glucose (血糖)                                                           │    │
│  │   必填: value                                                            │    │
│  │   可选: test_type (fasting/postprandial), meal_time                     │    │
│  │   范围: [1.0, 35.0]                                                      │    │
│  │   单位: mmol/L                                                           │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ sleep (睡眠)                                                             │    │
│  │   必填: duration                                                         │    │
│  │   可选: deep_sleep, light_sleep, rem_sleep, awake_times                 │    │
│  │   范围: [0, 24]                                                          │    │
│  │   单位: hours                                                            │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ temperature (体温)                                                       │    │
│  │   必填: value                                                            │    │
│  │   可选: measurement_site (oral/armpit/forehead)                         │    │
│  │   范围: [34.0, 42.0]                                                     │    │
│  │   单位: °C                                                               │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、API 接口汇总

| 端点 | 方法 | 说明 |
|------|------|------|
| `/api/iot/vitals/upload` | POST | 上传心率/血氧数据 |
| `/api/iot/vitals/batch` | POST | 批量上传数据 |
| `/api/iot/blood-pressure/upload` | POST | 上传血压数据 |
| `/api/iot/vitals/latest` | GET | 获取最新数据 |
| `/api/iot/devices/status` | GET | 获取设备状态 |
| `/api/iot/devices/bind` | POST | 绑定设备到用户 |
| `/api/iot/devices/bindings` | GET | 获取绑定列表 |
| `/api/iot/pipeline/status` | GET | 获取流水线状态 |
| `/api/iot/ws/vitals` | WebSocket | 实时数据推送 |
