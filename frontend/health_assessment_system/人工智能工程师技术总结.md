# 人工智能工程师技术总结

> 养生之道智能健康管理系统 - AI 智能体模块

---

## 一、模块概览

人工智能工程师部分负责 **多智能体系统、RAG 知识库、健康报告生成、智能问诊** 的完整 AI 能力链路。

### 代码文件清单

| 目录 | 文件 | 功能 | 代码行数 |
|------|------|------|----------|
| **agents/** | `base_agent.py` | 智能体基类定义 | 266 行 |
| | `agent_coordinator.py` | 智能体协调器 | 290 行 |
| | `multi_agent_system.py` | 多智能体系统入口 | 391 行 |
| | `health_butler.py` | 健康管家智能体 | 566 行 |
| | `chronic_disease_expert.py` | 慢病专家智能体 | 519 行 |
| | `lifestyle_coach.py` | 生活方式教练 | ~470 行 |
| | `emotional_care.py` | 心理关怀师智能体 | 494 行 |
| **modules/** | `rag_knowledge_base.py` | RAG 知识库 (FAISS) | 691 行 |

**总代码量**：约 **3,700+ 行** Python 代码

---

## 二、技术架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       多智能体系统架构图                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│                         用户输入                                         │
│                            ↓                                            │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │              MultiAgentSystem (多智能体系统)                      │   │
│   │                                                                   │   │
│   │   ┌───────────────────────────────────────────────────────────┐  │   │
│   │   │           AgentCoordinator (协调器)                        │  │   │
│   │   │                                                            │  │   │
│   │   │   意图识别 → 路由分发 → 响应整合                            │  │   │
│   │   └───────────────────────────────────────────────────────────┘  │   │
│   │                            ↓                                     │   │
│   │   ┌─────────────────────────────────────────────────────────┐   │   │
│   │   │                    智能体集群                             │   │   │
│   │   │                                                           │   │   │
│   │   │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐         │   │   │
│   │   │  │ 健康管家 │ │ 慢病专家 │ │ 生活教练 │ │心理关怀师│         │   │   │
│   │   │  │  小康    │ │         │ │         │ │         │         │   │   │
│   │   │  │ 👨‍⚕️     │ │ 🩺      │ │ 🏃      │ │ 🤗      │         │   │   │
│   │   │  │(默认)   │ │         │ │         │ │         │         │   │   │
│   │   │  └─────────┘ └─────────┘ └─────────┘ └─────────┘         │   │   │
│   │   └─────────────────────────────────────────────────────────┘   │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                            ↓                                            │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                     支撑系统                                      │   │
│   │  ┌───────────────┐  ┌───────────────┐  ┌───────────────────┐    │   │
│   │  │ RAG 知识库    │  │ 健康评估引擎  │  │ 大语言模型(LLM)   │    │   │
│   │  │ FAISS 向量库  │  │ 数据分析模块  │  │ DeepSeek / Qwen   │    │   │
│   │  └───────────────┘  └───────────────┘  └───────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────┘   │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心模块详解

### 3.1 智能体基类 (BaseAgent)

**文件**: `agents/base_agent.py`

#### 核心抽象
```python
class BaseAgent(ABC):
    """智能体基类"""
    
    def __init__(self, name, role, description, avatar, personality):
        self.name = name
        self.role = role              # AgentRole 枚举
        self.description = description
        self.avatar = avatar          # 表情符号
        self.personality = personality
        self.capabilities = []        # 能力列表
    
    @abstractmethod
    def process(self, message: AgentMessage, memory: AgentMemory) -> AgentMessage:
        """处理消息并生成响应"""
        pass
    
    @abstractmethod
    def can_handle(self, message: AgentMessage, context: Dict) -> float:
        """判断能否处理该消息，返回置信度 0-1"""
        pass
```

#### 智能体角色枚举
```python
class AgentRole(Enum):
    HEALTH_BUTLER = "health_butler"      # 健康管家（主交互）
    CHRONIC_EXPERT = "chronic_expert"    # 慢病专家
    LIFESTYLE_COACH = "lifestyle_coach"  # 生活方式教练
    EMOTIONAL_CARE = "emotional_care"    # 心理关怀师
    COORDINATOR = "coordinator"          # 协调器
```

#### 消息数据结构
```python
@dataclass
class AgentMessage:
    id: str                           # 消息ID
    type: MessageType                 # 类型：用户输入/智能体响应/思考过程
    role: AgentRole                   # 发送者角色
    content: str                      # 内容
    emotion: EmotionState             # 情绪状态
    timestamp: datetime               # 时间戳
    metadata: Dict[str, Any]          # 元数据
```

#### 记忆系统
```python
@dataclass
class AgentMemory:
    user_id: str
    short_term: List[AgentMessage]    # 短期记忆（当前对话，最近20条）
    long_term: Dict[str, Any]         # 长期记忆（用户画像）
    context: Dict[str, Any]           # 上下文信息
```

---

### 3.2 智能体协调器 (AgentCoordinator)

**文件**: `agents/agent_coordinator.py`

#### 核心职责
1. **注册管理**：管理所有智能体的注册和注销
2. **消息路由**：根据消息内容选择最合适的智能体
3. **协作调度**：协调多智能体协作处理复杂问题
4. **响应整合**：整合多个智能体的响应

#### 路由算法
```python
def route_message(self, message, context) -> Tuple[BaseAgent, float]:
    """路由消息到最合适的智能体"""
    best_agent = None
    best_confidence = 0.0
    
    # 遍历所有智能体，计算处理置信度
    for role, agent in self.agents.items():
        if agent.is_active:
            confidence = agent.can_handle(message, context)
            if confidence > best_confidence:
                best_confidence = confidence
                best_agent = agent
    
    # 如果没有合适的，使用默认智能体
    if best_agent is None and self.default_agent:
        best_agent = self.agents.get(self.default_agent)
        best_confidence = 0.5
    
    return best_agent, best_confidence
```

---

### 3.3 多智能体系统 (MultiAgentSystem)

**文件**: `agents/multi_agent_system.py`

#### 使用示例
```python
system = MultiAgentSystem(user_id="USER001", user_name="张爷爷")
response = system.chat("我最近血压有点高")
print(response)  # 由慢病专家响应
```

#### 智能功能
```python
class MultiAgentSystem:
    def chat(self, user_input: str) -> str:
        # 1. 检查是否需要生成健康报告
        if self._should_generate_report(user_input):
            return self._generate_health_report()
        
        # 2. 检查是否需要专家会诊（多智能体协作）
        if self._should_consult_experts(user_input):
            return self._expert_consultation(user_input)
        
        # 3. 常规对话处理
        return self.coordinator.process_message(user_input, self.memory)
    
    def _should_generate_report(self, text):
        """判断是否需要生成健康报告"""
        keywords = ["评估", "报告", "分析", "总结", "看看情况"]
        return any(k in text for k in keywords)
```

---

### 3.4 四大智能体

#### 健康管家（小康）
**文件**: `agents/health_butler.py`

| 属性 | 值 |
|------|-----|
| 角色 | 主交互入口、默认智能体 |
| 头像 | 👨‍⚕️ |
| 性格 | 亲切、温暖、专业、耐心 |
| 能力 | 日常问候、健康查询、数据解读、提醒、情感关怀 |

```python
class HealthButlerAgent(BaseAgent):
    greetings = {
        "morning": ["早上好！记得吃早餐哦~"],
        "afternoon": ["下午好！工作之余别忘了活动活动~"],
        "evening": ["晚上好！记得放松心情~"],
        "night": ["夜深了，注意休息哦！"]
    }
```

#### 慢病专家
**文件**: `agents/chronic_disease_expert.py`

| 属性 | 值 |
|------|-----|
| 角色 | 专业慢病分析和建议 |
| 头像 | 🩺 |
| 性格 | 专业、严谨、细致 |
| 能力 | 高血压/糖尿病/血脂评估、用药提醒、复诊建议 |

```python
class ChronicDiseaseExpertAgent(BaseAgent):
    # 血压分级标准（中国高血压指南）
    bp_grades = {
        "正常": {"systolic": (0, 120), "diastolic": (0, 80)},
        "正常高值": {"systolic": (120, 140), "diastolic": (80, 90)},
        "1级高血压": {"systolic": (140, 160), "diastolic": (90, 100)},
        "2级高血压": {"systolic": (160, 180), "diastolic": (100, 110)},
        "3级高血压": {"systolic": (180, 999), "diastolic": (110, 999)}
    }
```

#### 生活方式教练
**文件**: `agents/lifestyle_coach.py`

| 属性 | 值 |
|------|-----|
| 角色 | 运动、饮食、睡眠指导 |
| 头像 | 🏃 |
| 性格 | 活力、鼓励、专业 |
| 能力 | 运动建议、饮食指导、睡眠改善、习惯养成 |

#### 心理关怀师
**文件**: `agents/emotional_care.py`

| 属性 | 值 |
|------|-----|
| 角色 | 情感支持与陪伴 |
| 头像 | 🤗 |
| 性格 | 温暖、共情、耐心、支持 |
| 能力 | 情感倾听、焦虑疏导、积极心理、陪伴支持 |

```python
class EmotionalCareAgent(BaseAgent):
    comforting_words = [
        "我理解您的感受，这些情绪都是正常的。",
        "无论发生什么，我都在这里陪伴您。",
    ]
    positive_quotes = [
        "知足常乐，简单的幸福最珍贵。",
        "家人健康，子女孝顺，就是最大的福气。"
    ]
```

---

### 3.5 RAG 知识库

**文件**: `modules/rag_knowledge_base.py`

#### 技术架构
```
┌─────────────────────────────────────────────────────────────┐
│                    RAG 工作流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│   用户问题 → 向量化 → FAISS 检索 → 相关知识 → LLM 生成答案   │
│                                                              │
│   ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐  │
│   │ 问题    │ →  │ Encoder │ →  │ FAISS   │ →  │ Top-K   │  │
│   │ Query   │    │ 向量化   │    │ 向量检索 │    │ 知识条目│  │
│   └─────────┘    └─────────┘    └─────────┘    └─────────┘  │
│                                                     ↓        │
│   ┌─────────────────────────────────────────────────────┐   │
│   │                    LLM 生成                          │   │
│   │   Prompt = 系统提示 + 检索知识 + 用户问题            │   │
│   └─────────────────────────────────────────────────────┘   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

#### 核心类
```python
@dataclass
class KnowledgeItem:
    id: str
    category: str      # 分类：慢病管理、用药指导、饮食建议等
    title: str
    content: str
    keywords: List[str]
    source: str        # 来源
    embedding: Optional[np.ndarray]

class HealthKnowledgeBase:
    def __init__(self, embedding_model="paraphrase-multilingual-MiniLM-L12-v2"):
        # 初始化向量化模型
        self.encoder = SentenceTransformer(embedding_model)
        # 初始化 FAISS 索引
        self.index = faiss.IndexFlatIP(self.embedding_dim)
    
    def add_knowledge(self, item: KnowledgeItem):
        """添加知识条目"""
        embedding = self.encoder.encode([item.content])[0]
        self.index.add(embedding.reshape(1, -1))
    
    def search(self, query: str, top_k: int = 5) -> List[KnowledgeItem]:
        """语义检索"""
        query_vec = self.encoder.encode([query])[0]
        scores, indices = self.index.search(query_vec.reshape(1, -1), top_k)
        return [self.knowledge_items[i] for i in indices[0]]
```

#### 知识分类
| 类别 | 说明 |
|------|------|
| 慢病管理 | 高血压、糖尿病、高血脂管理知识 |
| 用药指导 | 常见降压药、降糖药使用说明 |
| 饮食建议 | 老年人营养、低盐低糖饮食 |
| 运动指导 | 适合老年人的运动方式 |
| 急救知识 | 心梗、中风急救常识 |
| 心理健康 | 老年人心理调适 |

---

## 四、LLM 集成

### 支持的大模型

| 模型 | 接入方式 | 说明 |
|------|----------|------|
| DeepSeek | API 调用 | 主力模型 |
| Qwen2.5 | 本地部署 | 备选模型 |
| 讯飞星火 | API 调用 | 备选模型 |

### Prompt 设计示例

```python
HEALTH_BUTLER_PROMPT = """
你是"小康"，一个专业、亲切的健康管家。

## 角色定位
- 服务对象：老年人
- 说话风格：亲切、温暖、耐心
- 专业领域：日常健康咨询

## 行为准则
1. 使用简单易懂的语言
2. 多给予鼓励和关心
3. 涉及严重问题时建议就医
4. 不能替代医生诊断

## 当前用户信息
用户ID: {user_id}
姓名: {user_name}
最近健康数据: {health_data}

## 用户问题
{user_input}

请以"小康"的身份回答：
"""
```

---

## 五、健康报告生成

### 报告结构
```python
report = f"""📊 **健康评估报告**

**用户**: {user_id}
**评估时间**: {datetime.now().strftime('%Y-%m-%d %H:%M')}

---

**🏆 综合评分**: {result.overall_score:.1f}/100
**健康等级**: {result.health_level.value}

**📋 各维度评分**:
- 疾病风险: {disease_score}分
- 生活方式: {lifestyle_score}分
- 趋势分析: {trend_score}分

**⚠️ 主要风险因素**:
- 血压持续偏高
- 睡眠质量下降

**💡 建议**:
- 减少盐分摄入
- 保证每天7小时睡眠
"""
```

---

## 六、依赖库

```txt
# 向量检索
faiss-cpu>=1.7.0         # Facebook 向量检索库
sentence-transformers    # 文本向量化

# 大模型
openai                   # OpenAI API 风格调用
transformers             # HuggingFace Transformers
torch                    # PyTorch

# 数据处理
numpy
pandas
```

---

## 七、使用示例

### 7.1 基础对话
```python
from agents.multi_agent_system import MultiAgentSystem

# 初始化系统
system = MultiAgentSystem(user_id="USER001", user_name="张爷爷")

# 日常问候
response = system.chat("早上好")
# → "早上好！新的一天开始了，希望您今天精神饱满！"

# 健康咨询
response = system.chat("我血压145/92，高不高？")
# → 由慢病专家回答：分析血压等级、给出建议
```

### 7.2 RAG 知识检索
```python
from modules.rag_knowledge_base import HealthKnowledgeBase

kb = HealthKnowledgeBase()

# 加载知识
kb.load_from_file("knowledge/health_knowledge.json")

# 检索
results = kb.search("高血压怎么控制", top_k=3)
for item in results:
    print(f"[{item.category}] {item.title}")
```

---

## 八、总结

### 技术亮点

1. **多智能体协作**：4个专业智能体 + 1个协调器
2. **记忆系统**：短期对话记忆 + 长期用户画像
3. **RAG 增强**：FAISS 向量检索 + 医学知识库
4. **意图路由**：置信度算法自动选择最优智能体
5. **情感设计**：适老化语言风格、关怀表达

### 智能体矩阵

| 智能体 | 触发关键词 | 核心能力 |
|--------|------------|----------|
| 健康管家 | 默认/问候/查询 | 日常交互入口 |
| 慢病专家 | 血压/血糖/血脂 | 专业疾病分析 |
| 生活教练 | 运动/饮食/睡眠 | 生活方式指导 |
| 心理关怀 | 焦虑/担心/孤独 | 情感支持陪伴 |

### 技术栈

| 层级 | 技术 |
|------|------|
| 智能体框架 | 自研多智能体系统 |
| 向量检索 | FAISS + SentenceTransformers |
| 大模型 | DeepSeek / Qwen API |
| 数据结构 | Python dataclass |

---

*文档生成时间: 2024年12月*
*项目: 养生之道智能健康管理系统*
