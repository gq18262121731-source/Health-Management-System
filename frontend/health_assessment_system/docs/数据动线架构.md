# 智能诊断系统 - 数据处理动线

## 完整数据流架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  数据采集层                                      │
│                                                                                  │
│   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐      │
│   │  传感器   │   │  手动输入  │   │  批量导入  │   │  API调用  │   │  数据库   │      │
│   │  (IoT)   │   │  (表单)   │   │ (CSV/JSON)│   │ (第三方)  │   │ (MySQL)  │      │
│   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘   └────┬─────┘      │
│        │              │              │              │              │             │
│        └──────────────┴──────────────┴──────────────┴──────────────┘             │
│                                      │                                           │
│                              DataCollector                                       │
│                     ┌────────────────┴────────────────┐                          │
│                     │        RawDataRecord            │                          │
│                     │  - record_id                    │                          │
│                     │  - user_id                      │                          │
│                     │  - data_type                    │                          │
│                     │  - timestamp                    │                          │
│                     │  - values: Dict                 │                          │
│                     │  - source: DataSource           │                          │
│                     └────────────────┬────────────────┘                          │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  数据清洗层                                      │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                           DataCleaner                                    │   │
│   │                                                                          │   │
│   │   ① 去重 (Deduplication)                                                 │   │
│   │      └── 基于 user_id + timestamp + data_type 判断                       │   │
│   │                                                                          │   │
│   │   ② 异常值检测 (Outlier Detection)                                       │   │
│   │      ├── IQR方法: Q1 - 1.5*IQR ~ Q3 + 1.5*IQR                           │   │
│   │      ├── Z-score方法: |z| ≤ 3                                            │   │
│   │      └── 业务规则: 医学合理范围                                           │   │
│   │          ├── 血压: 收缩压 70-200, 舒张压 40-130                           │   │
│   │          ├── 血糖: 2.0-30.0 mmol/L                                       │   │
│   │          ├── 心率: 35-200 bpm                                            │   │
│   │          └── 体温: 35.0-41.0 °C                                          │   │
│   │                                                                          │   │
│   │   ③ 缺失值处理 (Missing Value)                                           │   │
│   │      ├── 前向填充 (ffill)                                                │   │
│   │      ├── 线性插值                                                        │   │
│   │      └── 均值/中位数填充                                                  │   │
│   │                                                                          │   │
│   │   ④ 格式标准化 (Formatting)                                              │   │
│   │      ├── 时间戳: ISO 8601 格式                                           │   │
│   │      └── 数值单位: 统一转换                                               │   │
│   │                                                                          │   │
│   │   ⑤ 数值归一化 (Normalization) [可选]                                    │   │
│   │      ├── Min-Max: (x - min) / (max - min)                               │   │
│   │      └── Z-score: (x - μ) / σ                                           │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                           │
│                     ┌────────────────┴────────────────┐                          │
│                     │     CleanedDataRecord           │                          │
│                     │  + DataQualityReport            │                          │
│                     │    - quality_score              │                          │
│                     │    - completeness               │                          │
│                     │    - accuracy                   │                          │
│                     │    - outliers_detected          │                          │
│                     └────────────────┬────────────────┘                          │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  数据处理层                                      │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                         FeatureEngineer                                  │   │
│   │                                                                          │   │
│   │   ① 统计特征                                                             │   │
│   │      ├── 均值 (mean)                                                     │   │
│   │      ├── 标准差 (std)                                                    │   │
│   │      ├── 最大值/最小值                                                   │   │
│   │      └── 变异系数 (CV = std/mean)                                        │   │
│   │                                                                          │   │
│   │   ② 趋势特征                                                             │   │
│   │      ├── 线性回归斜率                                                    │   │
│   │      ├── 7日移动平均                                                     │   │
│   │      └── 环比变化率                                                      │   │
│   │                                                                          │   │
│   │   ③ 达标特征                                                             │   │
│   │      ├── 血压达标率 (<140/90)                                            │   │
│   │      ├── 血糖达标率 (<7.0)                                               │   │
│   │      └── 运动达标天数 (≥6000步)                                          │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        HealthAssessment                                  │   │
│   │                                                                          │   │
│   │   ① 单病种评估                                                           │   │
│   │      ├── HypertensionAssessor (高血压)                                   │   │
│   │      ├── DiabetesAssessor (糖尿病)                                       │   │
│   │      └── DyslipidemiAssessor (血脂异常)                                  │   │
│   │                                                                          │   │
│   │   ② 生活方式评估                                                         │   │
│   │      ├── SleepQualityAssessor (睡眠)                                     │   │
│   │      ├── ExerciseAssessor (运动)                                         │   │
│   │      └── DietAssessor (饮食)                                             │   │
│   │                                                                          │   │
│   │   ③ 综合评估                                                             │   │
│   │      ├── AHP权重计算 (疾病0.45, 生活0.30, 趋势0.25)                       │   │
│   │      ├── TOPSIS多准则排序                                                │   │
│   │      └── 分层分级 (优秀/良好/亚健康/需关注/高风险)                         │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                           │
│                     ┌────────────────┴────────────────┐                          │
│                     │   ProcessedHealthFeatures       │                          │
│                     │   + HealthAssessmentResult      │                          │
│                     │     - overall_score             │                          │
│                     │     - health_level              │                          │
│                     │     - dimension_scores          │                          │
│                     │     - recommendations           │                          │
│                     └────────────────┬────────────────┘                          │
└──────────────────────────────────────┼──────────────────────────────────────────┘
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                  数据可视化层                                    │
│                                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                          API 输出接口                                    │   │
│   │                                                                          │   │
│   │   GET  /api/health/today          → 今日健康数据（卡片展示）              │   │
│   │   GET  /api/health/charts         → 图表数据（心率/睡眠/血压/雷达）       │   │
│   │   GET  /api/health/heart-rate     → 心率趋势数据                         │   │
│   │   GET  /api/health/blood-pressure → 血压趋势数据                         │   │
│   │   GET  /api/health/sleep          → 睡眠分析数据                         │   │
│   │   GET  /api/health/radar          → 健康雷达图数据                       │   │
│   │   GET  /api/health/visualization  → 评估可视化数据                       │   │
│   │   POST /api/health/assessment     → 运行健康评估                         │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
│                                      │                                           │
│                                      ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────────┐   │
│   │                        前端展示 (React)                                  │   │
│   │                                                                          │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐    │   │
│   │   │ 健康卡片     │  │ 心率折线图   │  │ 睡眠柱状图   │  │ 血压趋势图   │    │   │
│   │   │ (今日数据)   │  │ (24小时)    │  │ (7天)       │  │ (7天)       │    │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘    │   │
│   │                                                                          │   │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                     │   │
│   │   │ 健康雷达图   │  │ 评估报告     │  │ AI健康建议   │                     │   │
│   │   │ (6维度)     │  │ (综合评分)   │  │ (智能体对话) │                     │   │
│   │   └─────────────┘  └─────────────┘  └─────────────┘                     │   │
│   │                                                                          │   │
│   └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 核心模块说明

### 1. 数据采集层 (DataCollector)

| 数据源 | 采集方式 | 实现状态 |
|--------|----------|----------|
| 传感器 (IoT) | 设备推送/轮询 | 🔲 待接入 |
| 手动输入 | POST API | ✅ 已实现 |
| 批量导入 | CSV/JSON解析 | ✅ 已实现 |
| API调用 | HTTP请求 | 🔲 待接入 |
| 数据库 | MySQL查询 | 🔲 待接入 |

**支持的数据类型：**
- `blood_pressure` - 血压 (systolic, diastolic)
- `glucose` - 血糖 (value, test_type)
- `heart_rate` - 心率 (value)
- `weight` - 体重 (value, body_fat)
- `sleep` - 睡眠 (duration, deep_sleep, light_sleep)
- `steps` - 步数 (value, distance, calories)
- `temperature` - 体温 (value)
- `spo2` - 血氧 (value)

---

### 2. 数据清洗层 (DataCleaner)

| 清洗步骤 | 方法 | 说明 |
|----------|------|------|
| 去重 | 时间戳+类型判重 | 同一时间点只保留一条 |
| 异常值检测 | IQR / Z-score | 超出1.5倍四分位距或3倍标准差 |
| 业务规则 | 医学范围过滤 | 如血压 70-200 mmHg |
| 缺失值 | 插值/填充 | 前向填充或线性插值 |
| 标准化 | Min-Max / Z-score | 归一化到 [0,1] 或标准正态 |

**数据质量评分公式：**
```
质量评分 = 完整性 × 0.4 + 准确性 × 0.4 + 一致性 × 0.2

其中：
- 完整性 = 有效记录数 / 总记录数
- 准确性 = (总数 - 异常值) / 总数
- 一致性 = (总数 - 重复数) / 总数
```

---

### 3. 数据处理层 (FeatureEngineer + HealthAssessment)

#### 特征工程

| 特征类型 | 计算方法 | 应用场景 |
|----------|----------|----------|
| 均值/标准差 | np.mean/std | 基础统计 |
| 变异系数 | CV = std/mean | 血压波动性 |
| 线性趋势 | 线性回归斜率 | 指标变化趋势 |
| 达标率 | 达标次数/总次数 | 控制效果评估 |

#### 健康评估权重 (AHP层次分析法)

```
                    综合健康评分
                         │
        ┌────────────────┼────────────────┐
        │                │                │
   疾病风险(45%)    生活方式(30%)    趋势分析(25%)
        │                │                │
   ┌────┴────┐      ┌────┴────┐      ┌────┴────┐
   │高血压 │糖尿病│  │睡眠│运动│    │血压趋势│
   │血脂异常│...  │  │饮食│... │    │血糖趋势│
   └─────────┘      └─────────┘      └─────────┘
```

---

### 4. 数据可视化层

| 前端组件 | 后端API | 数据格式 |
|----------|---------|----------|
| HeartRateChart | /api/health/heart-rate | `[{time, value}]` |
| SleepAnalysisChart | /api/health/sleep | `[{day, deepSleep, lightSleep}]` |
| BloodPressureChart | /api/health/blood-pressure | `[{day, systolic, diastolic}]` |
| HealthRadarChart | /api/health/radar | `[{subject, score, lastMonth}]` |
| HealthCard | /api/health/today | `{vitalSigns, activity, weight}` |

---

## 代码文件对照

| 层级 | 文件路径 | 核心类/函数 |
|------|----------|-------------|
| 数据采集 | `core/data_pipeline.py` | `DataCollector` |
| 数据清洗 | `core/data_pipeline.py` | `DataCleaner` |
| 特征工程 | `modules/data_preparation.py` | `FeatureEngineer` |
| 健康评估 | `modules/disease_assessment.py` | `*Assessor` |
| 综合评估 | `modules/comprehensive_assessment.py` | `RiskFusionEngine` |
| 服务层 | `core/health_data_service.py` | `HealthDataService` |
| API层 | `web_digital_human/app.py` | Flask路由 |

---

## 使用示例

```python
from core.data_pipeline import get_pipeline, DataSource

# 1. 初始化管道
pipeline = get_pipeline()

# 2. 采集数据
pipeline.collect(
    user_id="elderly_001",
    data_type="blood_pressure",
    values={"systolic": 135, "diastolic": 85},
    source=DataSource.MANUAL
)

# 3. 执行清洗
cleaned_data, quality_report = pipeline.clean(
    user_id="elderly_001",
    data_type="blood_pressure",
    days=30
)

print(f"数据质量评分: {quality_report.quality_score}")
print(f"去除异常值: {quality_report.outliers_detected}")

# 4. 获取处理摘要
summary = pipeline.get_pipeline_summary("elderly_001")
print(summary)
```
