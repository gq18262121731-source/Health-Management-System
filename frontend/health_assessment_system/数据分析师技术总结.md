# 数据分析师技术总结

> 养生之道智能健康管理系统 - 数据处理与分析模块

---

## 一、模块概览

本项目数据分析师部分负责 **数据生成、数据清洗、特征工程、健康评估** 的完整数据处理链路。

### 代码文件清单

| 目录 | 文件 | 功能 | 代码行数 |
|------|------|------|----------|
| **数据生成/** | `user_profiles.py` | 用户画像定义（10类老年人特征） | 459 行 |
| | `user_generator.py` | 用户基础信息生成器 | 258 行 |
| | `health_generator.py` | 健康监测数据生成器 | 638 行 |
| | `generate_all.py` | 数据生成主入口 + CSV导出 | ~300 行 |
| **数据层/** | `data_pipeline.py` | 数据采集 + 清洗流水线 | 945 行 |
| | `data_preparation.py` | 特征工程模块 | 530 行 |
| | `health_data_service.py` | 数据服务层 | ~800 行 |
| | `database_manager.py` | 数据库连接管理 | ~200 行 |
| **modules/** | `indicator_evaluator.py` | 指标评估器 | 356 行 |
| | `comprehensive_assessment.py` | 综合健康评估（AHP+TOPSIS） | 689 行 |
| | `disease_assessment.py` | 单病种评估 | ~900 行 |
| | `lifestyle_assessment.py` | 生活方式评估 | ~700 行 |

**总代码量**：约 **6,000+ 行** Python 代码

---

## 二、数据处理架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           数据流架构图                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐               │
│  │   数据生成    │ →  │   数据清洗    │ →  │   特征工程    │              │
│  │              │    │              │    │              │               │
│  │ • 用户画像    │    │ • 去重       │    │ • 统计特征    │               │
│  │ • 健康数据    │    │ • 异常值检测  │    │ • 趋势特征    │               │
│  │ • CSV/JSON   │    │ • 缺失值填充  │    │ • 达标率计算  │               │
│  └──────────────┘    └──────────────┘    └──────────────┘               │
│         │                   │                   │                        │
│         ↓                   ↓                   ↓                        │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                       健康评估引擎                                 │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │ 单病种评估   │  │ 生活方式评估 │  │ 趋势分析     │                │   │
│  │  │ • 高血压     │  │ • 睡眠      │  │ • 线性回归   │                │   │
│  │  │ • 糖尿病     │  │ • 运动      │  │ • 波动检测   │                │   │
│  │  │ • 血脂异常   │  │ • 饮食      │  │ • 异常预警   │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  │                          ↓                                         │   │
│  │  ┌──────────────────────────────────────────────────────────────┐ │   │
│  │  │            综合评估（AHP权重 + TOPSIS排序）                     │ │   │
│  │  │  → 综合健康评分 (0-100)                                        │ │   │
│  │  │  → 健康等级分层（优秀/良好/亚健康/需关注/高风险）                 │ │   │
│  │  │  → TOP风险因素提取                                             │ │   │
│  │  └──────────────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────────────┘   │
│                                   ↓                                      │
│  ┌──────────────────────────────────────────────────────────────────┐   │
│  │                          API 输出                                  │   │
│  │   /api/health/today   /api/health/radar   /api/health/assessment  │   │
│  └──────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心算法详解

### 3.1 异常值检测算法

**文件**: `data_preparation.py` → `DataPreprocessor` 类

#### IQR 方法（四分位距法）
```python
def _remove_outliers_iqr(self, data: np.ndarray):
    q1 = np.percentile(data, 25)
    q3 = np.percentile(data, 75)
    iqr = q3 - q1
    
    lower_bound = q1 - 1.5 * iqr
    upper_bound = q3 + 1.5 * iqr
    
    mask = (data >= lower_bound) & (data <= upper_bound)
    return data[mask], mask
```

**原理**：基于数据的四分位数，超出 `[Q1-1.5*IQR, Q3+1.5*IQR]` 范围的值视为异常值。

#### Z-Score 方法
```python
def _remove_outliers_zscore(self, data: np.ndarray):
    z_scores = np.abs(stats.zscore(data))
    mask = z_scores < 3.0  # 阈值为3个标准差
    return data[mask], mask
```

**原理**：标准化后，距离均值超过3个标准差的值视为异常值。

---

### 3.2 特征工程

**文件**: `data_preparation.py` → `FeatureEngineer` 类

#### 构建的特征类型

| 特征类型 | 计算方法 | 适用场景 |
|----------|----------|----------|
| **统计特征** | 均值、标准差、最大/最小值 | 基础健康状态描述 |
| **变异特征** | 变异系数 CV = std/mean | 血糖波动、血压稳定性 |
| **趋势特征** | 线性回归斜率 | 体重变化、指标趋势 |
| **达标率** | 正常值比例 | 血压/血糖控制效果 |
| **规律性特征** | 标准差倒数 | 睡眠/作息规律性 |

#### 特征集合定义（FeatureSet）
```python
@dataclass
class FeatureSet:
    # 血压特征
    sbp_mean, sbp_std, sbp_max, sbp_min
    sbp_trend          # 趋势斜率
    sbp_cv             # 变异系数
    sbp_compliance_rate # 达标率
    
    # 血糖特征
    glucose_mean, glucose_cv, glucose_compliance_rate
    
    # 睡眠特征
    sleep_duration_mean, sleep_regularity_score
    sleep_insufficient_days
    
    # 运动特征
    steps_mean, active_days_ratio
    
    # ... 更多指标
```

---

### 3.3 健康评估算法

**文件**: `comprehensive_assessment.py`

#### AHP 层次分析法（权重确定）

**用途**：确定各维度在综合评估中的权重

```python
# 默认权重配置
default_weights = {
    'disease_risk': 0.45,    # 疾病风险权重最高
    'lifestyle_risk': 0.30,  # 生活方式次之
    'trend_risk': 0.25       # 趋势变化
}

# 疾病内部权重
disease_weights = {
    'hypertension': 0.40,
    'diabetes': 0.35,
    'dyslipidemia': 0.25
}
```

**一致性检验**：
```python
def check_consistency(self, comparison_matrix):
    # 计算最大特征值
    lambda_max = np.max(eigenvalues.real)
    # 一致性指标
    ci = (lambda_max - n) / (n - 1)
    # 一致性比率 CR < 0.1 为可接受
    cr = ci / ri
    return cr
```

#### TOPSIS 多准则决策（排序）

**用途**：在多个候选方案中选出最优解

```python
def topsis_rank(self, scores: Dict[str, float], weights: Dict[str, float]):
    # 1. 构建加权标准化矩阵
    # 2. 确定理想解和负理想解
    # 3. 计算到理想解的距离
    # 4. 计算相对贴近度
    closeness = d_negative / (d_positive + d_negative)
    return closeness  # 越接近1越好
```

---

### 3.4 指标评估器

**文件**: `indicator_evaluator.py`

#### 参考范围定义
```python
reference_ranges = {
    'spo2': ReferenceRange(
        name='血氧',
        unit='%',
        normal_low=95, normal_high=100,
        warning_low=90, critical_low=85
    ),
    'systolic_bp': ReferenceRange(
        name='收缩压',
        unit='mmHg',
        normal_low=90, normal_high=140,
        warning_high=160, critical_high=180
    ),
    # ... 更多指标
}
```

#### 状态判断逻辑
```python
def _determine_status(self, value, ref):
    if value >= ref.critical_high:
        return CRITICAL_HIGH, "明显高于参考上限"
    if value <= ref.critical_low:
        return CRITICAL_LOW, "明显低于参考下限"
    if value >= ref.warning_high:
        return HIGH, "高于参考范围"
    if value <= ref.warning_low:
        return LOW, "低于参考范围"
    if value > ref.normal_high:
        return SLIGHTLY_HIGH, "略高于参考上限"
    if value < ref.normal_low:
        return SLIGHTLY_LOW, "略低于参考下限"
    return NORMAL, "位于参考范围内"
```

---

## 四、数据生成模块

### 4.1 用户画像设计

**文件**: `user_profiles.py`

定义了 **10类典型老年人画像**：

| 画像ID | 类型 | 特征 |
|--------|------|------|
| healthy_1/2 | 健康老人 | 指标正常，规律作息 |
| hypertension_1/2 | 高血压患者 | 血压偏高，服药控制中 |
| diabetes_1/2 | 糖尿病前期 | 空腹血糖 6.1-7.0 |
| suboptimal_1/2 | 亚健康老人 | 睡眠差，运动少 |
| multiple_1/2 | 多病共存 | 血压+血糖+血脂异常 |

### 4.2 时间规律模拟

**文件**: `health_generator.py`

```python
def _time_factor(self, hour: int, data_type: str):
    if data_type == "blood_pressure":
        # 晨峰效应：6-10点血压较高
        if 6 <= hour <= 10:
            return random.uniform(5, 15)
        elif 22 <= hour or hour <= 4:
            return random.uniform(-8, -3)
    
    elif data_type == "heart_rate":
        # 睡眠时心率低，活动时高
        if 0 <= hour <= 5:
            return random.uniform(-12, -8)
        elif 10 <= hour <= 18:
            return random.uniform(3, 10)
```

### 4.3 生成的数据类型

| 数据类型 | 每日记录数 | 字段 |
|----------|------------|------|
| blood_pressure | 2次 | systolic, diastolic, pulse |
| glucose | 1-2次 | value, test_type, meal_time |
| heart_rate | 4次 | value, activity_level |
| sleep | 1次 | duration, deep_sleep, quality_score |
| steps | 1次 | value, distance, calories |
| weight | 1次 | value, bmi |
| temperature | 1次 | value, measurement_site |
| spo2 | 2次 | value, perfusion_index |

---

## 五、数据清洗流水线

**文件**: `data_pipeline.py`

### 5.1 清洗步骤

```
数据采集 → 去重 → 异常值检测 → 缺失值填充 → 格式化 → 标准化
```

### 5.2 数据质量报告

```python
@dataclass
class DataQualityReport:
    total_records: int        # 总记录数
    valid_records: int        # 有效记录数
    duplicates_removed: int   # 去重数量
    outliers_detected: int    # 异常值数量
    missing_filled: int       # 缺失填充数量
    
    quality_score: float      # 质量评分 0-100
    completeness: float       # 完整性
    accuracy: float           # 准确性
    consistency: float        # 一致性
```

---

## 六、使用示例

### 6.1 数据生成
```python
from 数据生成.user_generator import generate_users
from 数据生成.health_generator import generate_health_data

# 生成10个用户
users = generate_users(seed=42)

# 生成30天健康数据
records = generate_health_data(users, days=30)
```

### 6.2 特征工程
```python
from 数据层.data_preparation import FeatureEngineer, HealthMetrics

engineer = FeatureEngineer()
features = engineer.build_features(
    user_id='USER001',
    raw_data={'blood_pressure': bp_data},
    assessment_period=(start_date, end_date)
)
```

### 6.3 健康评估
```python
from modules.comprehensive_assessment import ComprehensiveAssessment

assessment = ComprehensiveAssessment()
result = assessment.evaluate(user_id='USER001', features=features)

print(f"综合健康评分: {result.overall_score}")
print(f"健康等级: {result.health_level.value}")
print(f"TOP风险: {result.top_risk_factors}")
```

---

## 七、依赖库

```txt
numpy>=1.21.0          # 数值计算
pandas>=1.3.0          # 数据处理
scipy>=1.7.0           # 统计分析
scikit-learn>=0.24.0   # 机器学习（可选）
```

---

## 八、总结

### 技术亮点

1. **完整的数据处理链路**：从数据生成到健康评估的全流程覆盖
2. **医学专业性**：参考范围基于临床标准，评估逻辑符合医学规范
3. **可扩展架构**：模块化设计，易于添加新指标和评估维度
4. **真实数据模拟**：考虑时间规律、个体差异、异常值等真实场景

### 核心算法

| 算法 | 应用场景 |
|------|----------|
| IQR / Z-Score | 异常值检测 |
| 线性回归 | 趋势分析 |
| AHP 层次分析法 | 权重确定 |
| TOPSIS | 多准则决策排序 |

---

*文档生成时间: 2024年12月*
*项目: 养生之道智能健康管理系统*
